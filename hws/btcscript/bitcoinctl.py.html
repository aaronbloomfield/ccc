<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name="GENERATOR" content="GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite">
<title>bitcoinctl.py</title>
</head>
<body bgcolor="white">
<pre><tt><i><font color="#9A1900">#!/usr/bin/python3</font></i>

<i><font color="#9A1900"># This is the homework file for the BTC Parsing homework, which can be found</font></i>
<i><font color="#9A1900"># at http://aaronbloomfield.github.io/ccc/hws/btcscript.</font></i>

<i><font color="#9A1900"># Students are not expected to understand the contents of this file, although</font></i>
<i><font color="#9A1900"># they are welcome to look through it.</font></i>

<i><font color="#9A1900"># DO NOT EDIT THIS FILE!</font></i>


<b><font color="#000080">import</font></b> sys<font color="#990000">,</font> os<font color="#990000">,</font> requests<font color="#990000">,</font> hashlib

<b><font color="#000080">from</font></b> bitcoin <b><font color="#000080">import</font></b> SelectParams
<b><font color="#000080">from</font></b> bitcoin<font color="#990000">.</font>core <b><font color="#000080">import</font></b> b2x<font color="#990000">,</font> lx<font color="#990000">,</font> COIN<font color="#990000">,</font> CMutableTxIn<font color="#990000">,</font> CMutableTxOut<font color="#990000">,</font> COutPoint<font color="#990000">,</font> CMutableTransaction
<b><font color="#000080">from</font></b> bitcoin<font color="#990000">.</font>wallet <b><font color="#000080">import</font></b> CBitcoinSecret<font color="#990000">,</font> P2PKHBitcoinAddress<font color="#990000">,</font> CBitcoinAddress
<b><font color="#000080">from</font></b> bitcoin<font color="#990000">.</font>core<font color="#990000">.</font>script <b><font color="#000080">import</font></b> CScript<font color="#990000">,</font> SignatureHash<font color="#990000">,</font> SIGHASH_ALL
<b><font color="#000080">from</font></b> bitcoin<font color="#990000">.</font>core<font color="#990000">.</font>scripteval <b><font color="#000080">import</font></b> VerifyScript<font color="#990000">,</font> SCRIPT_VERIFY_P2SH

<b><font color="#000000">SelectParams</font></b><font color="#990000">(</font><font color="#FF0000">'testnet'</font><font color="#990000">)</font>

<b><font color="#000080">from</font></b> scripts <b><font color="#000080">import</font></b> <font color="#990000">*</font>


utxo <font color="#990000">=</font> <font color="#990000">-</font><font color="#993399">1</font>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">get_utxo_index</font></b><font color="#990000">():</font>
	<b><font color="#0000FF">global</font></b> utxo
	<b><font color="#0000FF">if</font></b> utxo <font color="#990000">==</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">:</font>
		<b><font color="#0000FF">assert</font></b> utxo_index <font color="#990000">!=</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">,</font> <font color="#FF0000">"UTXO not set to a valid value"</font>
		<b><font color="#0000FF">return</font></b> utxo_index
	<b><font color="#0000FF">else</font></b><font color="#990000">:</font>
		<b><font color="#0000FF">assert</font></b> utxo <font color="#990000">&gt;=</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#FF0000">"UTXO not set to a valid value"</font> 
		<b><font color="#0000FF">return</font></b> utxo

<b><font color="#0000FF">def</font></b> <b><font color="#000000">broadcast_transaction</font></b><font color="#990000">(</font>tx<font color="#990000">,</font> network<font color="#990000">):</font>
	<b><font color="#0000FF">if</font></b> network <font color="#990000">==</font> <font color="#FF0000">'btc-test3'</font><font color="#990000">:</font>
		url <font color="#990000">=</font> <font color="#FF0000">'https://api.blockcypher.com/v1/btc/test3/txs/push'</font>
	<b><font color="#0000FF">elif</font></b> network <font color="#990000">==</font> <font color="#FF0000">'bcy-test'</font><font color="#990000">:</font>
		url <font color="#990000">=</font> <font color="#FF0000">'https://api.blockcypher.com/v1/bcy/test/txs/push'</font>
	<b><font color="#0000FF">else</font></b><font color="#990000">:</font>
		<b><font color="#0000FF">raise</font></b> <b><font color="#000000">Exception</font></b><font color="#990000">(</font><font color="#FF0000">"Network must be one of either 'btc-test3', 'bcy-test'"</font><font color="#990000">)</font>
	raw_transaction <font color="#990000">=</font> <b><font color="#000000">b2x</font></b><font color="#990000">(</font>tx<font color="#990000">.</font><b><font color="#000000">serialize</font></b><font color="#990000">())</font>
	headers <font color="#990000">=</font> <font color="#990000">{</font><font color="#FF0000">'content-type'</font><font color="#990000">:</font> <font color="#FF0000">'application/x-www-form-urlencoded'</font><font color="#990000">}</font>
	<b><font color="#0000FF">if</font></b> broadcast_transactions<font color="#990000">:</font>
		<b><font color="#0000FF">return</font></b> requests<font color="#990000">.</font><b><font color="#000000">post</font></b><font color="#990000">(</font>url<font color="#990000">,</font> headers<font color="#990000">=</font>headers<font color="#990000">,</font> data<font color="#990000">=</font><font color="#FF0000">'{"tx": "%s"}'</font> <font color="#990000">%</font> raw_transaction<font color="#990000">)</font>
	<b><font color="#0000FF">else</font></b><font color="#990000">:</font>
		<b><font color="#0000FF">return</font></b> None


<b><font color="#0000FF">def</font></b> <b><font color="#000000">split_coins</font></b><font color="#990000">(</font>which<font color="#990000">):</font>
	<b><font color="#0000FF">if</font></b> which <font color="#990000">==</font> <font color="#FF0000">'split'</font><font color="#990000">:</font>
		my_private_key <font color="#990000">=</font> <b><font color="#000000">CBitcoinSecret</font></b><font color="#990000">(</font>my_private_key_str<font color="#990000">)</font>
		txid <font color="#990000">=</font> txid_split
		network <font color="#990000">=</font> <font color="#FF0000">'btc-test3'</font>
	<b><font color="#0000FF">else</font></b><font color="#990000">:</font> <i><font color="#9A1900"># split == 'splitbcy'</font></i>
		my_private_key <font color="#990000">=</font> CBitcoinSecret<font color="#990000">.</font><b><font color="#000000">from_secret_bytes</font></b><font color="#990000">(</font><b><font color="#000000">x</font></b><font color="#990000">(</font>bob_private_key_bcy_str<font color="#990000">))</font>
		txid <font color="#990000">=</font> txid_bob_bcy_funding
		network <font color="#990000">=</font> <font color="#FF0000">'bcy-test'</font>
	my_public_key <font color="#990000">=</font> my_private_key<font color="#990000">.</font>pub
	address <font color="#990000">=</font> P2PKHBitcoinAddress<font color="#990000">.</font><b><font color="#000000">from_pubkey</font></b><font color="#990000">(</font>my_public_key<font color="#990000">)</font>
	txin_scriptPubKey <font color="#990000">=</font> address<font color="#990000">.</font><b><font color="#000000">to_scriptPubKey</font></b><font color="#990000">()</font>
	txin <font color="#990000">=</font> <b><font color="#000000">CMutableTxIn</font></b><font color="#990000">(</font><b><font color="#000000">COutPoint</font></b><font color="#990000">(</font><b><font color="#000000">lx</font></b><font color="#990000">(</font>txid<font color="#990000">),</font> <b><font color="#000000">get_utxo_index</font></b><font color="#990000">()))</font>
	txout_scriptPubKey <font color="#990000">=</font> address<font color="#990000">.</font><b><font color="#000000">to_scriptPubKey</font></b><font color="#990000">()</font>
	split_utxo_output <font color="#990000">=</font> split_amount_to_split <font color="#990000">/</font> split_into_n
	txout <font color="#990000">=</font> <b><font color="#000000">CMutableTxOut</font></b><font color="#990000">(</font>split_utxo_output<font color="#990000">*</font>COIN<font color="#990000">,</font> <b><font color="#000000">CScript</font></b><font color="#990000">(</font>txout_scriptPubKey<font color="#990000">))</font>
	tx <font color="#990000">=</font> <b><font color="#000000">CMutableTransaction</font></b><font color="#990000">([</font>txin<font color="#990000">],</font> <font color="#990000">[</font>txout<font color="#990000">]*(</font>split_into_n<font color="#990000">-</font><font color="#993399">1</font><font color="#990000">))</font>
	sighash <font color="#990000">=</font> <b><font color="#000000">SignatureHash</font></b><font color="#990000">(</font>txin_scriptPubKey<font color="#990000">,</font> tx<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> SIGHASH_ALL<font color="#990000">)</font>
	txin<font color="#990000">.</font>scriptSig <font color="#990000">=</font> <b><font color="#000000">CScript</font></b><font color="#990000">([</font>my_private_key<font color="#990000">.</font><b><font color="#000000">sign</font></b><font color="#990000">(</font>sighash<font color="#990000">)</font> <font color="#990000">+</font> <b><font color="#000000">bytes</font></b><font color="#990000">([</font>SIGHASH_ALL<font color="#990000">]),</font> my_public_key<font color="#990000">])</font>
	<b><font color="#000000">VerifyScript</font></b><font color="#990000">(</font>txin<font color="#990000">.</font>scriptSig<font color="#990000">,</font> txin_scriptPubKey<font color="#990000">,</font> tx<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#990000">(</font>SCRIPT_VERIFY_P2SH<font color="#990000">,))</font>
	response <font color="#990000">=</font> <b><font color="#000000">broadcast_transaction</font></b><font color="#990000">(</font>tx<font color="#990000">,</font>network<font color="#990000">)</font>
	<b><font color="#0000FF">if</font></b> <b><font color="#0000FF">not</font></b> broadcast_transactions<font color="#990000">:</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">"Not broadcasting transactions, so no response received"</font><font color="#990000">)</font>
	<b><font color="#0000FF">else</font></b><font color="#990000">:</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font>response<font color="#990000">.</font>status_code<font color="#990000">,</font> response<font color="#990000">.</font>reason<font color="#990000">)</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font>response<font color="#990000">.</font>text<font color="#990000">)</font>


<b><font color="#0000FF">def</font></b> <b><font color="#000000">keygen</font></b><font color="#990000">(</font>_<font color="#990000">):</font>
	private_key <font color="#990000">=</font> CBitcoinSecret<font color="#990000">.</font><b><font color="#000000">from_secret_bytes</font></b><font color="#990000">(</font>os<font color="#990000">.</font><b><font color="#000000">urandom</font></b><font color="#990000">(</font><font color="#993399">32</font><font color="#990000">))</font>
	<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">"Private key:"</font><font color="#990000">,</font> private_key<font color="#990000">)</font>
	<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">"Address:"</font><font color="#990000">,</font> P2PKHBitcoinAddress<font color="#990000">.</font><b><font color="#000000">from_pubkey</font></b><font color="#990000">(</font>private_key<font color="#990000">.</font>pub<font color="#990000">))</font>


<b><font color="#0000FF">def</font></b> <b><font color="#000000">get_urls</font></b><font color="#990000">(</font>_<font color="#990000">):</font>
	urlbase <font color="#990000">=</font> <font color="#FF0000">"live.blockcypher.com/btc-testnet"</font>
	<i><font color="#9A1900">#urlbase = "www.blockchain.com/btc-testnet" # not using, as it's slow to update</font></i>
	<b><font color="#0000FF">if</font></b> my_invoice_address_str <font color="#990000">!=</font> <font color="#FF0000">""</font><font color="#990000">:</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">"Your tBTC wallet:  \thttps://"</font> <font color="#990000">+</font> urlbase <font color="#990000">+</font> <font color="#FF0000">"/address/"</font> <font color="#990000">+</font> my_invoice_address_str<font color="#990000">)</font>
	<b><font color="#0000FF">if</font></b> bob_invoice_address_str <font color="#990000">!=</font> <font color="#FF0000">""</font><font color="#990000">:</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">"Bob's tBTC wallet:  \thttps://"</font> <font color="#990000">+</font> urlbase <font color="#990000">+</font> <font color="#FF0000">"/address/"</font> <font color="#990000">+</font> bob_invoice_address_str<font color="#990000">)</font>
	tbtc_txids <font color="#990000">=</font> <font color="#990000">{}</font>
	<b><font color="#0000FF">for</font></b> i <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font><b><font color="#000000">len</font></b><font color="#990000">(</font>txid_funding_list<font color="#990000">)):</font>
		tbtc_txids<font color="#990000">[</font><font color="#FF0000">"Initial funding TXN "</font> <font color="#990000">+</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>i<font color="#990000">+</font><font color="#993399">1</font><font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">":"</font><font color="#990000">]</font> <font color="#990000">=</font> txid_funding_list<font color="#990000">[</font>i<font color="#990000">]</font>
	<b><font color="#0000FF">for</font></b> i <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font><b><font color="#000000">len</font></b><font color="#990000">(</font>txid_split_list<font color="#990000">)):</font>
		tbtc_txids<font color="#990000">[</font><font color="#FF0000">"Split TXN "</font> <font color="#990000">+</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>i<font color="#990000">+</font><font color="#993399">1</font><font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">":     "</font><font color="#990000">]</font> <font color="#990000">=</font> txid_split_list<font color="#990000">[</font>i<font color="#990000">]</font>
	tbtc_txids<font color="#990000">[</font><font color="#FF0000">"\nPart 1: P2PKH TX:"</font><font color="#990000">]</font> <font color="#990000">=</font> txid_p2pkh
	tbtc_txids<font color="#990000">[</font><font color="#FF0000">"\nPart 2a: puzzle TX 1:"</font><font color="#990000">]</font> <font color="#990000">=</font> txid_puzzle_txn1
	tbtc_txids<font color="#990000">[</font><font color="#FF0000">"Part 2b: puzzle TX 2:"</font><font color="#990000">]</font> <font color="#990000">=</font> txid_puzzle_txn2
	tbtc_txids<font color="#990000">[</font><font color="#FF0000">"\nPart 3a: multisig TX 1:"</font><font color="#990000">]</font> <font color="#990000">=</font> txid_multisig_txn1
	tbtc_txids<font color="#990000">[</font><font color="#FF0000">"Part 3b: multisig TX 2:"</font><font color="#990000">]</font> <font color="#990000">=</font> txid_multisig_txn2
	tbtc_txids<font color="#990000">[</font><font color="#FF0000">"\nPart 4a: your send TX:"</font><font color="#990000">]</font> <font color="#990000">=</font> txid_atomicswap_alice_send_tbtc
	tbtc_txids<font color="#990000">[</font><font color="#FF0000">"Part 4d: B's redeem TX:"</font><font color="#990000">]</font> <font color="#990000">=</font> txid_atomicswap_bob_redeem_tbtc

	<b><font color="#0000FF">for</font></b> k<font color="#990000">,</font>v <b><font color="#0000FF">in</font></b> tbtc_txids<font color="#990000">.</font><b><font color="#000000">items</font></b><font color="#990000">():</font>
		<b><font color="#0000FF">if</font></b> v <font color="#990000">!=</font> <font color="#FF0000">""</font><font color="#990000">:</font>
			<b><font color="#0000FF">print</font></b><font color="#990000">(</font>k <font color="#990000">+</font> <font color="#FF0000">"\thttps://"</font> <font color="#990000">+</font> urlbase <font color="#990000">+</font> <font color="#FF0000">"/tx/"</font> <font color="#990000">+</font> v<font color="#990000">)</font>
	<i><font color="#9A1900"># BCY wallets and transactions</font></i>
	urlbase <font color="#990000">=</font> <font color="#FF0000">"live.blockcypher.com/bcy"</font>
	<b><font color="#0000FF">if</font></b> my_invoice_address_bcy_str <font color="#990000">!=</font> <font color="#FF0000">""</font><font color="#990000">:</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">"\nYour BCY wallet:  \thttps://"</font> <font color="#990000">+</font> urlbase <font color="#990000">+</font> <font color="#FF0000">"/address/"</font> <font color="#990000">+</font> my_invoice_address_bcy_str<font color="#990000">)</font>
	<b><font color="#0000FF">if</font></b> bob_invoice_address_bcy_str <font color="#990000">!=</font> <font color="#FF0000">""</font><font color="#990000">:</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">"Bob's BCY wallet:  \thttps://"</font> <font color="#990000">+</font> urlbase <font color="#990000">+</font> <font color="#FF0000">"/address/"</font> <font color="#990000">+</font> bob_invoice_address_bcy_str<font color="#990000">)</font>
	bcy_txids <font color="#990000">=</font> <font color="#990000">{</font><font color="#FF0000">"Bob's BCY funding TX:"</font><font color="#990000">:</font>txid_bob_bcy_funding<font color="#990000">,</font>
				 <font color="#FF0000">"Bob's BCY split TX:"</font><font color="#990000">:</font>txid_bob_bcy_split<font color="#990000">,</font>
				 <font color="#FF0000">"Part 4b: B's send TX:"</font><font color="#990000">:</font>txid_atomicswap_bob_send_bcy<font color="#990000">,</font>
				 <font color="#FF0000">"Part 4c: your redeem TX"</font><font color="#990000">:</font>txid_atomicswap_alice_redeem_bcy<font color="#990000">,</font>
				<font color="#990000">}</font>
	<b><font color="#0000FF">for</font></b> k<font color="#990000">,</font>v <b><font color="#0000FF">in</font></b> bcy_txids<font color="#990000">.</font><b><font color="#000000">items</font></b><font color="#990000">():</font>
		<b><font color="#0000FF">if</font></b> v <font color="#990000">!=</font> <font color="#FF0000">""</font><font color="#990000">:</font>
			<b><font color="#0000FF">print</font></b><font color="#990000">(</font>k <font color="#990000">+</font> <font color="#FF0000">"\thttps://"</font> <font color="#990000">+</font> urlbase <font color="#990000">+</font> <font color="#FF0000">"/tx/"</font> <font color="#990000">+</font> v<font color="#990000">)</font>


<b><font color="#0000FF">def</font></b> <b><font color="#000000">create_signed_transaction</font></b><font color="#990000">(</font>txin<font color="#990000">,</font> txout<font color="#990000">,</font> txin_scriptPubKey<font color="#990000">,</font>
                              txin_scriptSig<font color="#990000">,</font> verify_script <font color="#990000">=</font> True<font color="#990000">):</font>
	tx <font color="#990000">=</font> <b><font color="#000000">CMutableTransaction</font></b><font color="#990000">([</font>txin<font color="#990000">],</font> <font color="#990000">[</font>txout<font color="#990000">])</font>
	txin<font color="#990000">.</font>scriptSig <font color="#990000">=</font> <b><font color="#000000">CScript</font></b><font color="#990000">(</font>txin_scriptSig<font color="#990000">)</font>
	<i><font color="#9A1900">#print(txin, "\n\n", txout, "\n\n", txin_scriptPubKey, "\n\n", txin_scriptSig)</font></i>
	<b><font color="#0000FF">if</font></b> verify_script<font color="#990000">:</font>
	    <b><font color="#000000">VerifyScript</font></b><font color="#990000">(</font>txin<font color="#990000">.</font>scriptSig<font color="#990000">,</font> <b><font color="#000000">CScript</font></b><font color="#990000">(</font>txin_scriptPubKey<font color="#990000">),</font>
	                 tx<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#990000">(</font>SCRIPT_VERIFY_P2SH<font color="#990000">,))</font>
	<b><font color="#0000FF">return</font></b> tx


<b><font color="#0000FF">def</font></b> <b><font color="#000000">handle_txn</font></b><font color="#990000">(</font>param<font color="#990000">):</font>
	<i><font color="#9A1900"># get the sender info</font></i>
	sender_private_key <font color="#990000">=</font> <b><font color="#000000">CBitcoinSecret</font></b><font color="#990000">(</font>my_private_key_str<font color="#990000">)</font>
	sender_public_key <font color="#990000">=</font> sender_private_key<font color="#990000">.</font>pub
	sender_address <font color="#990000">=</font> P2PKHBitcoinAddress<font color="#990000">.</font><b><font color="#000000">from_pubkey</font></b><font color="#990000">(</font>sender_public_key<font color="#990000">)</font>
	<i><font color="#9A1900"># get hash of secret for part 4</font></i>
	shahash <font color="#990000">=</font> hashlib<font color="#990000">.</font><b><font color="#000000">new</font></b><font color="#990000">(</font><font color="#FF0000">'sha256'</font><font color="#990000">)</font>
	rmdhash <font color="#990000">=</font> hashlib<font color="#990000">.</font><b><font color="#000000">new</font></b><font color="#990000">(</font><font color="#FF0000">'ripemd160'</font><font color="#990000">)</font>
	shahash<font color="#990000">.</font><b><font color="#000000">update</font></b><font color="#990000">(</font>atomic_swap_secret<font color="#990000">.</font><b><font color="#000000">to_bytes</font></b><font color="#990000">(</font><font color="#993399">4</font><font color="#990000">,</font><font color="#FF0000">'little'</font><font color="#990000">))</font>
	rmdhash<font color="#990000">.</font><b><font color="#000000">update</font></b><font color="#990000">(</font>shahash<font color="#990000">.</font><b><font color="#000000">digest</font></b><font color="#990000">())</font>
	secret_hash <font color="#990000">=</font> rmdhash<font color="#990000">.</font><b><font color="#000000">digest</font></b><font color="#990000">()</font>
	<i><font color="#9A1900">#secret_hash = secret_hash[::-1]</font></i>
	<i><font color="#9A1900"># set up our transaction output</font></i>
	<b><font color="#0000FF">if</font></b> param <font color="#990000">==</font> <font color="#FF0000">"part2a"</font><font color="#990000">:</font>
		txout_scriptPubKey <font color="#990000">=</font> <b><font color="#000000">puzzle_scriptPubKey</font></b><font color="#990000">()</font>
	<b><font color="#0000FF">elif</font></b> param <font color="#990000">==</font> <font color="#FF0000">"part3a"</font><font color="#990000">:</font>
		txout_scriptPubKey <font color="#990000">=</font> <b><font color="#000000">multisig_scriptPubKey</font></b><font color="#990000">()</font>
	<b><font color="#0000FF">elif</font></b> param <font color="#990000">==</font> <font color="#FF0000">"part4a"</font><font color="#990000">:</font>
		txout_scriptPubKey <font color="#990000">=</font> <b><font color="#000000">atomicswap_scriptPubKey</font></b><font color="#990000">(</font>sender_public_key<font color="#990000">,</font> bob_private_key<font color="#990000">.</font>pub<font color="#990000">,</font> secret_hash<font color="#990000">)</font>
	<b><font color="#0000FF">elif</font></b> param <font color="#990000">==</font> <font color="#FF0000">"part4b"</font><font color="#990000">:</font>
		bob_prikey_bcy <font color="#990000">=</font> CBitcoinSecret<font color="#990000">.</font><b><font color="#000000">from_secret_bytes</font></b><font color="#990000">(</font><b><font color="#000000">x</font></b><font color="#990000">(</font>bob_private_key_bcy_str<font color="#990000">))</font>
		my_prikey_bcy <font color="#990000">=</font> CBitcoinSecret<font color="#990000">.</font><b><font color="#000000">from_secret_bytes</font></b><font color="#990000">(</font><b><font color="#000000">x</font></b><font color="#990000">(</font>my_private_key_bcy_str<font color="#990000">))</font>
		txout_scriptPubKey <font color="#990000">=</font> <b><font color="#000000">atomicswap_scriptPubKey</font></b><font color="#990000">(</font>bob_prikey_bcy<font color="#990000">.</font>pub<font color="#990000">,</font> my_prikey_bcy<font color="#990000">.</font>pub<font color="#990000">,</font> secret_hash<font color="#990000">)</font>
	<b><font color="#0000FF">elif</font></b> param <font color="#990000">==</font> <font color="#FF0000">"part4c"</font><font color="#990000">:</font>
		txout_scriptPubKey <font color="#990000">=</font> <b><font color="#000000">P2PKH_scriptPubKey</font></b><font color="#990000">(</font>bcy_dest_address<font color="#990000">)</font>
	<b><font color="#0000FF">else</font></b><font color="#990000">:</font> <i><font color="#9A1900"># all others: pay to the facuet address</font></i>
		txout_scriptPubKey <font color="#990000">=</font> <b><font color="#000000">P2PKH_scriptPubKey</font></b><font color="#990000">(</font>tbtc_return_address<font color="#990000">)</font>
	<i><font color="#9A1900"># second transactions have to lower the send_amount to allow for fees</font></i>
	factor <font color="#990000">=</font> <font color="#993399">1.0</font>
	<b><font color="#0000FF">if</font></b> param <b><font color="#0000FF">in</font></b> <font color="#990000">[</font><font color="#FF0000">'part2b'</font><font color="#990000">,</font><font color="#FF0000">'part3b'</font><font color="#990000">,</font><font color="#FF0000">'part4c'</font><font color="#990000">,</font><font color="#FF0000">'part4d'</font><font color="#990000">]:</font>
		factor <font color="#990000">=</font> <font color="#993399">0.9</font>
	txout <font color="#990000">=</font> <b><font color="#000000">CMutableTxOut</font></b><font color="#990000">(</font>factor<font color="#990000">*</font>send_amount<font color="#990000">*</font>COIN<font color="#990000">,</font> <b><font color="#000000">CScript</font></b><font color="#990000">(</font>txout_scriptPubKey<font color="#990000">))</font>
	<i><font color="#9A1900"># set up our transaction input; this varies for the different parts, but</font></i>
	<i><font color="#9A1900"># many are spending a standard P2PKH transaction from the faucet (or split)</font></i>
	<b><font color="#0000FF">if</font></b> param <b><font color="#0000FF">in</font></b> <font color="#990000">[</font><font color="#FF0000">"part1"</font><font color="#990000">,</font> <font color="#FF0000">"part2a"</font><font color="#990000">,</font> <font color="#FF0000">"part3a"</font><font color="#990000">,</font><font color="#FF0000">"part4a"</font><font color="#990000">]:</font>
		txin_scriptPubKey <font color="#990000">=</font> <b><font color="#000000">P2PKH_scriptPubKey</font></b><font color="#990000">(</font>sender_address<font color="#990000">)</font>
		txin <font color="#990000">=</font> <b><font color="#000000">CMutableTxIn</font></b><font color="#990000">(</font><b><font color="#000000">COutPoint</font></b><font color="#990000">(</font><b><font color="#000000">lx</font></b><font color="#990000">(</font>txid_utxo<font color="#990000">),</font> <b><font color="#000000">get_utxo_index</font></b><font color="#990000">()))</font>
		txin_scriptSig <font color="#990000">=</font> <b><font color="#000000">P2PKH_scriptSig</font></b><font color="#990000">(</font>txin<font color="#990000">,</font> txout<font color="#990000">,</font> txin_scriptPubKey<font color="#990000">,</font> sender_private_key<font color="#990000">)</font>
	<b><font color="#0000FF">elif</font></b> param <font color="#990000">==</font> <font color="#FF0000">"part2b"</font><font color="#990000">:</font>
		txin_scriptPubKey <font color="#990000">=</font> <b><font color="#000000">puzzle_scriptPubKey</font></b><font color="#990000">()</font>
		txin <font color="#990000">=</font> <b><font color="#000000">CMutableTxIn</font></b><font color="#990000">(</font><b><font color="#000000">COutPoint</font></b><font color="#990000">(</font><b><font color="#000000">lx</font></b><font color="#990000">(</font>txid_puzzle_txn1<font color="#990000">),</font> <b><font color="#000000">get_utxo_index</font></b><font color="#990000">()))</font>
		txin_scriptSig <font color="#990000">=</font> <b><font color="#000000">puzzle_scriptSig</font></b><font color="#990000">()</font>
	<b><font color="#0000FF">elif</font></b> param <font color="#990000">==</font> <font color="#FF0000">"part3b"</font><font color="#990000">:</font>
		txin_scriptPubKey <font color="#990000">=</font> <b><font color="#000000">multisig_scriptPubKey</font></b><font color="#990000">()</font>
		txin <font color="#990000">=</font> <b><font color="#000000">CMutableTxIn</font></b><font color="#990000">(</font><b><font color="#000000">COutPoint</font></b><font color="#990000">(</font><b><font color="#000000">lx</font></b><font color="#990000">(</font>txid_multisig_txn1<font color="#990000">),</font> <b><font color="#000000">get_utxo_index</font></b><font color="#990000">()))</font>
		txin_scriptSig <font color="#990000">=</font> <b><font color="#000000">multisig_scriptSig</font></b><font color="#990000">(</font>txin<font color="#990000">,</font> txout<font color="#990000">,</font> txin_scriptPubKey<font color="#990000">)</font>
	<b><font color="#0000FF">elif</font></b> param <font color="#990000">==</font> <font color="#FF0000">"part4b"</font><font color="#990000">:</font>
		bob_prikey_bcy <font color="#990000">=</font> CBitcoinSecret<font color="#990000">.</font><b><font color="#000000">from_secret_bytes</font></b><font color="#990000">(</font><b><font color="#000000">x</font></b><font color="#990000">(</font>bob_private_key_bcy_str<font color="#990000">))</font>
		bob_invoice_addr_bcy <font color="#990000">=</font> P2PKHBitcoinAddress<font color="#990000">.</font><b><font color="#000000">from_pubkey</font></b><font color="#990000">(</font>bob_prikey_bcy<font color="#990000">.</font>pub<font color="#990000">)</font>
		txin_scriptPubKey <font color="#990000">=</font> <b><font color="#000000">P2PKH_scriptPubKey</font></b><font color="#990000">(</font>bob_invoice_addr_bcy<font color="#990000">)</font>
		txin <font color="#990000">=</font> <b><font color="#000000">CMutableTxIn</font></b><font color="#990000">(</font><b><font color="#000000">COutPoint</font></b><font color="#990000">(</font><b><font color="#000000">lx</font></b><font color="#990000">(</font>txid_bob_bcy_split<font color="#990000">),</font> <b><font color="#000000">get_utxo_index</font></b><font color="#990000">()))</font>
		txin_scriptSig <font color="#990000">=</font> <b><font color="#000000">P2PKH_scriptSig</font></b><font color="#990000">(</font>txin<font color="#990000">,</font> txout<font color="#990000">,</font> txin_scriptPubKey<font color="#990000">,</font> bob_prikey_bcy<font color="#990000">)</font>
	<b><font color="#0000FF">elif</font></b> param <font color="#990000">==</font> <font color="#FF0000">"part4c"</font><font color="#990000">:</font> <i><font color="#9A1900"># BCY Bob -&gt; Alice</font></i>
		<i><font color="#9A1900"># re-create UTXO's pubKey script and sign it</font></i>
		my_prikey_bcy <font color="#990000">=</font> CBitcoinSecret<font color="#990000">.</font><b><font color="#000000">from_secret_bytes</font></b><font color="#990000">(</font><b><font color="#000000">x</font></b><font color="#990000">(</font>my_private_key_bcy_str<font color="#990000">))</font>
		my_invoice_addr_bcy <font color="#990000">=</font> P2PKHBitcoinAddress<font color="#990000">.</font><b><font color="#000000">from_pubkey</font></b><font color="#990000">(</font>my_prikey_bcy<font color="#990000">.</font>pub<font color="#990000">)</font>
		bob_prikey_bcy <font color="#990000">=</font> CBitcoinSecret<font color="#990000">.</font><b><font color="#000000">from_secret_bytes</font></b><font color="#990000">(</font><b><font color="#000000">x</font></b><font color="#990000">(</font>bob_private_key_bcy_str<font color="#990000">))</font>
		txin_scriptPubKey <font color="#990000">=</font> <b><font color="#000000">atomicswap_scriptPubKey</font></b><font color="#990000">(</font>bob_prikey_bcy<font color="#990000">.</font>pub<font color="#990000">,</font> my_prikey_bcy<font color="#990000">.</font>pub<font color="#990000">,</font> secret_hash<font color="#990000">)</font>
		txin <font color="#990000">=</font> <b><font color="#000000">CMutableTxIn</font></b><font color="#990000">(</font><b><font color="#000000">COutPoint</font></b><font color="#990000">(</font><b><font color="#000000">lx</font></b><font color="#990000">(</font>txid_atomicswap_bob_send_bcy<font color="#990000">),</font> <b><font color="#000000">get_utxo_index</font></b><font color="#990000">()))</font>
		signature <font color="#990000">=</font> <b><font color="#000000">create_CHECKSIG_signature</font></b><font color="#990000">(</font>txin<font color="#990000">,</font>txout<font color="#990000">,</font>txin_scriptPubKey<font color="#990000">,</font>my_prikey_bcy<font color="#990000">)</font>
		<i><font color="#9A1900"># create our input (sigScript) script</font></i>
		txin_scriptSig <font color="#990000">=</font> <b><font color="#000000">atomcswap_scriptSig_redeem</font></b><font color="#990000">(</font>signature<font color="#990000">,</font>atomic_swap_secret<font color="#990000">)</font>
	<b><font color="#0000FF">elif</font></b> param <font color="#990000">==</font> <font color="#FF0000">"part4d"</font><font color="#990000">:</font> <i><font color="#9A1900"># tBTC Alice -&gt; Bob</font></i>
		<i><font color="#9A1900"># re-create UTXO's pubKey script and sign it</font></i>
		txin_scriptPubKey <font color="#990000">=</font> <b><font color="#000000">atomicswap_scriptPubKey</font></b><font color="#990000">(</font>sender_public_key<font color="#990000">,</font> bob_private_key<font color="#990000">.</font>pub<font color="#990000">,</font> secret_hash<font color="#990000">)</font>
		txin <font color="#990000">=</font> <b><font color="#000000">CMutableTxIn</font></b><font color="#990000">(</font><b><font color="#000000">COutPoint</font></b><font color="#990000">(</font><b><font color="#000000">lx</font></b><font color="#990000">(</font>txid_atomicswap_alice_send_tbtc<font color="#990000">),</font> <b><font color="#000000">get_utxo_index</font></b><font color="#990000">()))</font>
		signature <font color="#990000">=</font> <b><font color="#000000">create_CHECKSIG_signature</font></b><font color="#990000">(</font>txin<font color="#990000">,</font>txout<font color="#990000">,</font>txin_scriptPubKey<font color="#990000">,</font>bob_private_key<font color="#990000">)</font>
		<i><font color="#9A1900"># create our input (sigScript) script</font></i>
		txin_scriptSig <font color="#990000">=</font> <b><font color="#000000">atomcswap_scriptSig_redeem</font></b><font color="#990000">(</font>signature<font color="#990000">,</font>atomic_swap_secret<font color="#990000">)</font>
	<b><font color="#0000FF">else</font></b><font color="#990000">:</font>
		<b><font color="#0000FF">raise</font></b> <b><font color="#000000">Exception</font></b><font color="#990000">(</font><font color="#FF0000">"Unknown part in handle_txn():"</font><font color="#990000">,</font>param<font color="#990000">)</font>
	<i><font color="#9A1900"># which network?</font></i>
	network <font color="#990000">=</font> <font color="#FF0000">'btc-test3'</font>
	<b><font color="#0000FF">if</font></b> param <b><font color="#0000FF">in</font></b> <font color="#990000">[</font><font color="#FF0000">"part4b"</font><font color="#990000">,</font> <font color="#FF0000">"part4c"</font><font color="#990000">]:</font>
		network <font color="#990000">=</font> <font color="#FF0000">'bcy-test'</font>
	<i><font color="#9A1900"># combine into a new transaction, and broadcast</font></i>
	new_tx <font color="#990000">=</font> <b><font color="#000000">create_signed_transaction</font></b><font color="#990000">(</font>txin<font color="#990000">,</font> txout<font color="#990000">,</font> txin_scriptPubKey<font color="#990000">,</font> txin_scriptSig<font color="#990000">)</font>
	response <font color="#990000">=</font> <b><font color="#000000">broadcast_transaction</font></b><font color="#990000">(</font>new_tx<font color="#990000">,</font>network<font color="#990000">)</font>
	<b><font color="#0000FF">if</font></b> <b><font color="#0000FF">not</font></b> broadcast_transactions<font color="#990000">:</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">"Not broadcasting transactions, so no response received"</font><font color="#990000">)</font>
	<b><font color="#0000FF">else</font></b><font color="#990000">:</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font>response<font color="#990000">.</font>status_code<font color="#990000">,</font> response<font color="#990000">.</font>reason<font color="#990000">)</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font>response<font color="#990000">.</font>text<font color="#990000">)</font>


<b><font color="#0000FF">def</font></b> <b><font color="#000000">bcy_key</font></b><font color="#990000">(</font>_<font color="#990000">):</font>
	<b><font color="#0000FF">assert</font></b> blockcypher_api_token <font color="#990000">!=</font> <font color="#FF0000">""</font><font color="#990000">,</font> <font color="#FF0000">"You must fill in the blockcypher_api_token field for this to work"</font>
	r <font color="#990000">=</font> requests<font color="#990000">.</font><b><font color="#000000">post</font></b><font color="#990000">(</font>f<font color="#FF0000">'https://api.blockcypher.com/v1/bcy/test/addrs?token={blockcypher_api_token}'</font><font color="#990000">)</font>
	<b><font color="#0000FF">if</font></b> r<font color="#990000">.</font>status_code <font color="#990000">!=</font> <font color="#993399">200</font> <b><font color="#0000FF">and</font></b> r<font color="#990000">.</font>status_code <font color="#990000">!=</font> <font color="#993399">201</font><font color="#990000">:</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font>f<font color="#FF0000">"Error: the http request returned status code {r.status_code} ({r.reason}) (200 or 201 was expected), so something didn't work correctly."</font><font color="#990000">)</font>
	<b><font color="#0000FF">else</font></b><font color="#990000">:</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font>r<font color="#990000">.</font>text<font color="#990000">)</font>

<b><font color="#0000FF">def</font></b> <b><font color="#000000">fund_bob</font></b><font color="#990000">(</font>_<font color="#990000">):</font>
	<b><font color="#0000FF">assert</font></b> blockcypher_api_token <font color="#990000">!=</font> <font color="#FF0000">""</font><font color="#990000">,</font> <font color="#FF0000">"You must fill in the blockcypher_api_token field for this to work"</font>
	<b><font color="#0000FF">assert</font></b> bob_invoice_address_bcy_str <font color="#990000">!=</font> <font color="#FF0000">""</font><font color="#990000">,</font> <font color="#FF0000">"You must fill in the bob_invoice_address_bcy_str field for this to work"</font>
	r <font color="#990000">=</font> requests<font color="#990000">.</font><b><font color="#000000">post</font></b><font color="#990000">(</font>f<font color="#FF0000">"https://api.blockcypher.com/v1/bcy/test/faucet?token={blockcypher_api_token}"</font><font color="#990000">,</font> json<font color="#990000">={</font><font color="#FF0000">"address"</font><font color="#990000">:</font> bob_invoice_address_bcy_str<font color="#990000">,</font> <font color="#FF0000">"amount"</font><font color="#990000">:</font> <font color="#993399">100000</font><font color="#990000">})</font>
	<b><font color="#0000FF">if</font></b> r<font color="#990000">.</font>status_code <font color="#990000">!=</font> <font color="#993399">200</font> <b><font color="#0000FF">and</font></b> r<font color="#990000">.</font>status_code <font color="#990000">!=</font> <font color="#993399">201</font><font color="#990000">:</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font>f<font color="#FF0000">"Error: the http request returned status code {r.status_code} ({r.reason}) (200 or 201 was expected), so something didn't work correctly."</font><font color="#990000">)</font>
	<b><font color="#0000FF">else</font></b><font color="#990000">:</font>
		<b><font color="#0000FF">print</font></b><font color="#990000">(</font>r<font color="#990000">.</font>text<font color="#990000">)</font>


functions <font color="#990000">=</font> <font color="#990000">{</font>
	<font color="#FF0000">'keygen'</font><font color="#990000">:</font> keygen<font color="#990000">,</font>
	<font color="#FF0000">'genkey'</font><font color="#990000">:</font> keygen<font color="#990000">,</font>
	<font color="#FF0000">'split'</font><font color="#990000">:</font> split_coins<font color="#990000">,</font>
	<font color="#FF0000">'splitbcy'</font><font color="#990000">:</font> split_coins<font color="#990000">,</font>
	<font color="#FF0000">'part1'</font><font color="#990000">:</font> handle_txn<font color="#990000">,</font>
	<font color="#FF0000">'part2a'</font><font color="#990000">:</font> handle_txn<font color="#990000">,</font>
	<font color="#FF0000">'part2b'</font><font color="#990000">:</font> handle_txn<font color="#990000">,</font>
	<font color="#FF0000">'part3a'</font><font color="#990000">:</font> handle_txn<font color="#990000">,</font>
	<font color="#FF0000">'part3b'</font><font color="#990000">:</font> handle_txn<font color="#990000">,</font>
	<font color="#FF0000">'part4a'</font><font color="#990000">:</font> handle_txn<font color="#990000">,</font>
	<font color="#FF0000">'part4b'</font><font color="#990000">:</font> handle_txn<font color="#990000">,</font>
	<font color="#FF0000">'part4c'</font><font color="#990000">:</font> handle_txn<font color="#990000">,</font>
	<font color="#FF0000">'part4d'</font><font color="#990000">:</font> handle_txn<font color="#990000">,</font>
	<font color="#FF0000">'geturls'</font><font color="#990000">:</font> get_urls<font color="#990000">,</font>
	<font color="#FF0000">'urls'</font><font color="#990000">:</font> get_urls<font color="#990000">,</font>
	<font color="#FF0000">'url'</font><font color="#990000">:</font> get_urls<font color="#990000">,</font>
	<font color="#FF0000">'bcykey'</font><font color="#990000">:</font> bcy_key<font color="#990000">,</font>
	<font color="#FF0000">'bcy_key'</font><font color="#990000">:</font> bcy_key<font color="#990000">,</font>
	<font color="#FF0000">'fund_bob'</font><font color="#990000">:</font> fund_bob<font color="#990000">,</font>
	<font color="#FF0000">'fundbob'</font><font color="#990000">:</font> fund_bob<font color="#990000">,</font>
<font color="#990000">}</font>


<b><font color="#0000FF">def</font></b> <b><font color="#000000">sanity_checks</font></b><font color="#990000">():</font>
	<b><font color="#0000FF">if</font></b> my_private_key_str <font color="#990000">!=</font> <font color="#FF0000">""</font> <b><font color="#0000FF">or</font></b> my_invoice_address_str <font color="#990000">!=</font> <font color="#FF0000">""</font><font color="#990000">:</font>
		private_key <font color="#990000">=</font> <b><font color="#000000">CBitcoinSecret</font></b><font color="#990000">(</font>my_private_key_str<font color="#990000">)</font>
		public_key <font color="#990000">=</font> private_key<font color="#990000">.</font>pub
		address <font color="#990000">=</font> P2PKHBitcoinAddress<font color="#990000">.</font><b><font color="#000000">from_pubkey</font></b><font color="#990000">(</font>my_public_key<font color="#990000">)</font>
		<b><font color="#0000FF">assert</font></b><font color="#990000">(</font><b><font color="#000000">str</font></b><font color="#990000">(</font>address<font color="#990000">)</font> <font color="#990000">==</font> my_invoice_address_str<font color="#990000">)</font>


<b><font color="#0000FF">def</font></b> <b><font color="#000000">main</font></b><font color="#990000">():</font>
	<b><font color="#0000FF">global</font></b> utxo
	<b><font color="#0000FF">if</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>sys<font color="#990000">.</font>argv<font color="#990000">)</font> <font color="#990000">&lt;</font> <font color="#993399">2</font> <b><font color="#0000FF">or</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>sys<font color="#990000">.</font>argv<font color="#990000">)</font> <font color="#990000">&gt;</font> <font color="#993399">3</font><font color="#990000">:</font>
		<b><font color="#0000FF">print</font></b> <font color="#990000">(</font><font color="#FF0000">"You must supply at least one or two command-line parameters to use this program."</font><font color="#990000">)</font>
		<b><font color="#0000FF">print</font></b> <font color="#990000">(</font><font color="#FF0000">"See the homework for details."</font><font color="#990000">)</font>
		<b><font color="#000000">exit</font></b><font color="#990000">()</font>
	<b><font color="#0000FF">if</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>sys<font color="#990000">.</font>argv<font color="#990000">)</font> <font color="#990000">==</font> <font color="#993399">3</font><font color="#990000">:</font>
		<b><font color="#0000FF">try</font></b><font color="#990000">:</font>
			utxo <font color="#990000">=</font> <b><font color="#000000">int</font></b><font color="#990000">(</font>sys<font color="#990000">.</font>argv<font color="#990000">[</font><font color="#993399">2</font><font color="#990000">])</font>
		<b><font color="#0000FF">except</font></b><font color="#990000">:</font>
			<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">"Error: the second command-line parameter should be an integer UTXO"</font><font color="#990000">)</font>
			<b><font color="#000000">exit</font></b><font color="#990000">()</font>
	<b><font color="#0000FF">if</font></b> sys<font color="#990000">.</font>argv<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">]</font> <b><font color="#0000FF">not</font></b> <b><font color="#0000FF">in</font></b> functions<font color="#990000">.</font><b><font color="#000000">keys</font></b><font color="#990000">():</font>
		<b><font color="#0000FF">print</font></b> <font color="#990000">(</font><font color="#FF0000">"Unknown function:"</font><font color="#990000">,</font>sys<font color="#990000">.</font>argv<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">])</font>
		<b><font color="#000000">exit</font></b><font color="#990000">()</font>
	<b><font color="#0000FF">if</font></b> my_private_key_str <font color="#990000">!=</font> <font color="#FF0000">""</font> <b><font color="#0000FF">and</font></b> my_invoice_address_str <font color="#990000">!=</font> <font color="#FF0000">""</font><font color="#990000">:</font>
		<b><font color="#000000">sanity_checks</font></b><font color="#990000">()</font>
	functions<font color="#990000">[</font>sys<font color="#990000">.</font>argv<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">]](</font>sys<font color="#990000">.</font>argv<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">])</font>

<b><font color="#0000FF">if</font></b> __name__ <font color="#990000">==</font> <font color="#FF0000">'__main__'</font><font color="#990000">:</font>
	<b><font color="#000000">main</font></b><font color="#990000">()</font>
</tt></pre>
</body>
</html>
