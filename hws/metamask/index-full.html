<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>MetaMask Assignment</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="../../markdown.css" />
  <script>
  function openTab(evt, tabName) {
    // Declare all variables
    var i, tabcontent, tablinks;

    // Get all elements with class="tabcontent" and hide them
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }

    // Get all elements with class="tablinks" and remove the class "active"
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab, and add an "active" class to the button that opened the tab
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
  }

  function insertCopyLink(text) {
    document.write("<span class=\"copylink copy_img\" onclick=\"navigator.clipboard.writeText('" + text.replace(/\"/g,"\\'") + "')\"></span>");
  }
  </script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="metamask-assignment">MetaMask Assignment</h1>
<p><a href="../index.html">Go up to the CCC HW page</a> (<a href="../index.md">md</a>) | <a href="index.html">view tabbed version</a></p>
<h3 id="overview">Overview</h3>
<p>You are going to create a web interface for the Auctioneer contract you created in the <a href="../auction/index.html">dApp Auction</a> (<a href="../auction/index.md">md</a>) assignment. This web interface will allow for the creation of NFTs and the ability to start and stop auctions, as well as bidding on running auctions. The web page you create will reside on the departmental servers, just like with the <a href="../daoweb3/index.html">DAO &amp; web3</a> (<a href="../daoweb3/index.md">md</a>) assignment. This assignment will allow <em>writing</em> to the blockchain as well as reading from it.</p>
<p>Writing this homework will require completion of the following assignments:</p>
<ul>
<li><a href="../ethprivate/index.html">Private Ethereum Blockchain</a> (<a href="../ethprivate/index">md</a>)</li>
<li><a href="../daoweb3/index.html">DAO &amp; web3</a> (<a href="../daoweb3/index.md">md</a>) (this is for the experience with web3; the artifacts of that assignment are not needed for the current one)</li>
<li><a href="../tokens/index.html">Ethereum Tokens</a> (<a href="../tokens/index.md">md</a>)</li>
<li><a href="../arbitrage/index.html">Arbitrage trading</a> (<a href="../arbitrage/index.md">md</a>) (this is also for the experience with web3; the artifacts of that assignment are not needed for the current one)</li>
<li><a href="../auction/index.html">dApp Auction</a> (<a href="../auction/index.md">md</a>)</li>
</ul>
<p>We are going to use your Auctioneer contract, from the <a href="../auction/index.html">dApp Auction</a> (<a href="../auction/index.md">md</a>) assignment. You will also need your NFTmanager contract, from the <a href="../tokens/index.html">Ethereum Tokens</a> (<a href="../tokens/index.md">md</a>) assignment, as well. If you did not get either of those two contracts (Auctioneer or NFTManager) working, then contact the course staff, and we can deploy them for you to use. Otherwise you can either re-deploy your Auctioneer contract to the blockchain, or use the one you deployed for the <a href="../auction/index.html">dApp Auction</a> (<a href="../auction/index.md">md</a>) assignment. Save the contract address of your Auctioneer, as it will be needed when you submit your assignment.</p>
<p>In addition to your source code, you will submit an edited version of <a href="metamask.py.html">metamask.py</a> (<a href="metamask.py">src</a>).</p>
<h3 id="changelog">Changelog</h3>
<p>Any changes to this page will be put here for easy reference. Typo fixes and minor clarifications are not listed here. So far there aren’t any significant changes to report.</p>
<h3 id="metamask-setup">MetaMask Setup</h3>
<p><img src="metamask-pop-up.webp" style="float:right;border:1px solid black;margin-left:15px"></p>
<p>This assignment uses the <a href="https://metamask.io/">MetaMask</a> extension to Google Chrome. Unfortunately, it does not run in any other browser; meaning you can’t use Firefox, Safari, Edge, or Internet Explorer. You have to use Chrome for this assignment.</p>
<p>Here are the MetaMask setup steps:</p>
<ol type="1">
<li>If you haven’t already, install <a href="https://www.google.com/chrome">Google Chrome</a></li>
<li>Install the <a href="https://metamask.io/">MetaMask</a> extension; you will see a pop-up like the image to the right
<ul>
<li>Note that on some systems it is presented as a web page rather than a pop-up, but the content of the web page is the same as the pop-up shown to the right</li>
<li>When MetaMask first installs, it will ask you if you already have a secret recovery phrase or to create a wallet – you want to create a wallet</li>
<li>It will ask you to enter a password – remember it, as you will need it each time you start up MetaMask</li>
</ul></li>
<li>Click on the MetaMask icon (<img src="metamask-fox.svg" style="max-height:20px;vertical-align:middle">) next to the browser’s address box. You will see something similar to the image to the right.
<ul>
<li>Click the network drop-down box – in the image to the right it says “localhost:8545”, but in your version it will likely say “Ethereum Mainnet”.
<ul>
<li>In that drop-down list, select “add network”; this will bring up a web page</li>
<li>In the Settings column on the far left, click on Advanced</li>
<li>About half-way down there is a toggle setting to “show test networks” – make sure that is togged on</li>
</ul></li>
<li>In the settings column on the far left, click on the Networks option, then click on the “localhost:8545” network
<ul>
<li>Change the chain ID to the (base-10) value for our blockchain; that value can be found on the Canvas landing page</li>
<li>Change the explorer URL to the URL of the course explorer (on the Canvas landing page)</li>
<li>Then click save</li>
</ul></li>
<li>Back in the network selection box, you should now be able to select “localhost:8545” as your network – this is going to connect to the geth node that we will be starting in a moment</li>
</ul></li>
<li>Obtain your decrypted private key for the account that you want to use. This was done in Part 4 of the <a href="../ethprivate/index.html#part-4-extract-private-key">Private Ethereum Blockchain</a> (<a href="../ethprivate/index">md</a>) assignment, and you also used that in the <a href="../arbitrage/index.html">Arbitrage trading</a> (<a href="../arbitrage/index.md">md</a>) assignment. It will be a hex value of the form <code>0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef</code></li>
<li>Start your geth node. Among any other flags that you are using, you need to supply the <code>--http</code> flag when you start geth
<ul>
<li>This causes geth to start listening to port 8545 on your computer (aka localhost), which is how MetaMask will connect</li>
<li>Does it not connect? Make sure you are running your geth node with the <code>--http</code> flag.</li>
</ul></li>
<li>Configure your account in MetaMask. To do so, again click on the MetaMask icon (<img src="metamask-fox.svg" style="max-height:20px;vertical-align:middle">) next to the browser’s address box. You will again see something similar to the image to the right. Sometimes there is a noticeable delay when clicking that icon before the pop-up windows appears.
<ul>
<li>Click on the circular icon in the upper-right of the MetaMask window – in the image to the right it looks like: <img src="metamask-account-icon.webp" style="max-height:20px;vertical-align:middle">, but will likely look different in yours</li>
<li>Click on “import account” (NOT create account!)</li>
<li>Paste in your decrypted private key and click on ‘import’</li>
<li>You should now see your balance in the account pop-up window</li>
<li>You will likely want to rename the account – MetaMask just calls them “account 1”, “account 2”, etc., and makes it hard to delete “account 1”. To rename your account, in the MetaMask window in the image to the right, click on the vertical ellipsis (⋮) to the right of the account name, then click on “account details”, then click on the pencil/edit icon to the right of the account name.</li>
</ul></li>
</ol>
<p>At this point, the MetaMask extension should be connected to your account on the private Ethereum blockchain – you can tell if this is the case because it will report your balance in the MetaMask window. Note that if you restart Chrome, you may have to re-enter your MetaMask password. Also, it will say “Not connected” to the left of the account name – that’s fine for now, since we have not yet created a web page for it to connect to; that “Not connected” is that it is not connected to the current web page, it is not indicating a the presence (or lack thereof) of a connection to the blockchain.</p>
<p>If you are having problems with this setup, you can also have Metamask create a new account for you, and the fund it with the course faucet.</p>
<p><br clear="all"></p>
<!---

### Background: Function Call Encoding

We are going to be reading from the blockchain using the web3.js library that you used in the [DAO & web3](../daoweb3/index.html) ([md](../daoweb3/index.md)) assignment.  In fact, you are encouraged to start with the code of the NFT auction manager web site that was provided to you in the [dApp Auction](../auction/index.html) ([md](../auction/index.md)) assignment.  The intent of this current assignment is to add features to that web page.

We are going to be using a *different* mechanism to write to the blockchain as we do to read from it.  Reading from the blockchain is still using the web3.js code, and that should mostly be all done for you in the web site that was provided to you in the [dApp Auction](../auction/index.html) ([md](../auction/index.md)) assignment.

Why a separate system?  A few reasons.  One is that it lowers the amount of work to make it reasonable in a single assignment.  Another is that calling the read-only functions with web3.js is much easier.  And using this combination is still safe and secure, so it could be used in production.

The catch: in order to be able to call a smart contract that is a *transaction*, as opposed to a *call*, we have to encode the function call in hex ourselves.  To this end, you will need to read through the [function call encoding tutorial](../../docs/function_call_encoding.html) ([md](../../docs/function_call_encoding.md)).  You need to understand all of what is in there, as you will have to write Javascript code to do that encoding!  We aren't expecting you to have it memorized, but instead to use that document as a reference.

-->
<h3 id="your-url">Your URL</h3>
<p>This part is similar to what was in the <a href="../daoweb3/index.html">DAO &amp; web3 assignment</a> (<a href="../daoweb3/index.md">md</a>) assignment – you are going to add a <code>_xxxxxxxx</code> suffix on your metamask.html file name. so your filename will be of the form <code>metamask_xxxxxxxx.html</code>. <strong>HOWEVER,</strong> you also have to run <code>touch ~/public_html/index.html</code> (or similar) on the departmental server – see the “Preventing directory viewing” section. below.</p>
<p>You can determine your URL suffix as you did in the <a href="../daoweb3/index.html">DAO &amp; web3 assignment</a> (<a href="../daoweb3/index.md">md</a>) assignment. Thus, your file name on the departmental server is going to be of the form <code>metamask_xxxxxxxx.html</code>.</p>
<h4 id="preventing-directory-viewing">Preventing directory viewing</h4>
<p>(If you did this in the DAO&amp;web3 assignment, no need to repeat it here).</p>
<p>If you go to your home page on the departmental viewer, you can see all the files in the directory listing that shows up. To prevent this, we are going to create a default (and empty) index.html file. On the departmetnal server, you can just run <code>touch ~/public_html/index.html</code>.</p>
<p><strong>NOTE:</strong> If you already have a web page present, or otherwise have prevented (intentional or not) directory viewing, then no further steps are needed.</p>
<h3 id="web3.js">Web3.js</h3>
<p>The intent is for you to start with the web site that was provided to you in the <a href="../auction/index.html">dApp Auction</a> (<a href="../auction/index.md">md</a>) assignment, and add some features. The URL of that web site is on the Canvas landing page – you can just save that as a new HTML file, which you will want to name <code>metamask_xxxxxxxx.html</code>. Note: you have to view that page with an Auctioneer contract address else most of the relevant Javascript code will not be shown. The link to that page with an address is also on the Canvas landing page. You are going to create a few web forms, each of which will call a different Javascript function. Those forms – and the paired Javascript functions – will perform the various actions that we need to perform on the Auctioneer: minting new NFTs, starting a new auction, closing an auction, and bidding on an auction.</p>
<p>The <a href="../daoweb3/index.html">DAO &amp; web3 assignment</a> (<a href="../daoweb3/index.md">md</a>) goes over the basics of HTML web pages and Javascript functions.</p>
<h4 id="ensure-metamask-is-installed-and-enabled">Ensure MetaMask is installed and enabled</h4>
<p>We want to ensure that any viewer of this web page has MetaMask properly installed. The following code will do that:</p>
<pre><code>&lt;script&gt;
  if ( window.ethereum === undefined )
    window.alert(&quot;Please install MetaMask; this page will not work properly without that extension installed&quot;);
&lt;/script&gt;</code></pre>
<p>This is useful as it will give a warning to those using other browsers, or those on Chrome without the MetaMask extension installed, that the site won’t work properly. In a fully developed web site, we would display the rest of the page differently if it is run without MetaMask. For this assignment, you should just display that warning. It’s fine for this assignment if the rest of your page does not display correctly without MetaMask installed. You can put this code right after the <code>&lt;body&gt;</code> opening tag.</p>
<p>Beyond what is shown in the code above, you do not need to handle the situation where a user tries to use this page when not using Chrome with MetaMask installed.</p>
<h4 id="connecting-to-metamask">Connecting to MetaMask</h4>
<p>The first thing a user has to do is enable the MetaMask extension to use the site; this is usually phrased as “connecting to MetaMask”. To do this, we add the following code to our HTML file (adapted from <a href="https://docs.metamask.io/guide/getting-started.html#connecting-to-metamask">here</a>).</p>
<pre><code>&lt;script&gt;
function connectToMetaMask() {
    ethereum.request({ method: &#39;eth_requestAccounts&#39; });
}
&lt;/script&gt;
&lt;button onClick=&#39;connectToMetaMask()&#39;&gt;Enable Ethereum&lt;/button&gt;</code></pre>
<p>Yes, there are better ways to do this in Javascript, such as adding event listeners. No, we don’t need those for this assignment – although you are welcome to do so if you are familiar with Javascript.</p>
<p>This connection will persist through a page reload, and – on some operating systems at least – will persist thorough a browser restart. You can test if this works by connecting and then disconnecting. To disconnect, click on the MetaMask icon (<img src="metamask-fox.svg" style="max-height:20px;vertical-align:middle">) next to the browser’s address box, then click on the “Connected” button (to the left of the account name), and the vertical ellipsis (⋮) that appears will allow you to disconnect.</p>
<p>The expectation is that any user will first click on that button to connect to MetaMask. You do not need to handle the situation when a user tries to use the rest of the page without first connecting via this button.</p>
<h4 id="web3.js-library">Web3.js library</h4>
<p>We could interact with MetaMask directly, but using web3.js, which we are familiar with, is going to make life much easier – it will do all the encoding of parameters into calls, etc.</p>
<p>Previously, we defined the <code>web3</code> variable as such (The value for <code>URL</code> is on the Canvas landing page):</p>
<pre><code>let web3 = new Web3(&#39;URL&#39;);</code></pre>
<p>We are now going to <em>add</em> a line:</p>
<pre><code>let web3 = new Web3(&#39;URL&#39;);
let web3mm = new Web3(window.ethereum);</code></pre>
<p>You will notice that we are creating <em>TWO</em> connections to the blockchain. The first connection is through the normal URL as was done in the <a href="../daoweb3/index.html">DAO &amp; web3</a> (<a href="../daoweb3/index.md">md</a>) assignment and as is done in the auctions.php page that you are basing your code off of; that URL is on the Canvas landing page. This first connection is <em>read-only</em>. The second connection is through MetaMask, which injects the <code>window.ethereum</code> object, and Web3.js can just connect via that. We will be able to send transactions through the second connection.</p>
<p>The reason we are doing two connections is because the first one supports subscriptions, which is what allows the table to be updated upon an event emission – you did that in the <a href="../daoweb3/index.html">DAO &amp; web3</a> (<a href="../daoweb3/index.md">md</a>) assignment, and the auctions.php does that as well. However, that first connection does not allow sending transactions to the blockchain. The second connection, which is through MetaMask, does not support subscriptions (so no automatic updating of the tables), but does allow sending transactions to the blockchain.</p>
<p>As both are wrapped in the Web3 constructor, you interact with them in the same way.</p>
<p>As a general rule, any one Javascript function should use only one of those connections, as they may be slightly out of sync with each other (the MetaMask one has about a 5 second delay, for example). If you are sending transactions to the blockchain, you have to use the <code>web3mm</code> connection. Otherwise, use the <code>web3</code> connection. As you will only be writing five functions that send transactions to the blockchain, only those five will use <code>web3mm</code>.</p>
<p>Likewise, we need an auction contract interface that connects through the <code>web3mm</code> connection. Currently there is this line of code in the HTML file:</p>
<pre><code>auctionContract = new web3.eth.Contract(auctioneerAbi,auctioneerContractAddress);</code></pre>
<p>We are going to <em>add</em> a line:</p>
<pre><code>auctionContractmm = new web3mm.eth.Contract(auctioneerAbi,auctioneerContractAddress);</code></pre>
<p>If a function is using the <code>web3mm</code> connection, then it should use the <code>auctionContractmm</code> contract interface.</p>
<p>You will have to do something similar with your connection the NFTManager.</p>
<h3 id="html-and-js">HTML and JS</h3>
<p>Below is an example HTML form and associated Javascript function. This will call the <code>mintWithURI()</code> function on your NFTManager smart contract.</p>
<pre><code>&lt;h4&gt;Mint NFT&lt;/h4&gt;
&lt;script&gt;
  const mintNFT = async() =&gt; {
    try {
      const eth_coinbase = web3mm.utils.toChecksumAddress(await web3mm.eth.getCoinbase());
      var str = document.getElementById(&#39;nftstring&#39;).value;
      const txninfo = await nftContractmm.methods.mintWithURI(str).send({from:eth_coinbase, gas:1000000, gasPrice:1000000000});
      showReturnIntegerValue(web3mm,txninfo[&#39;transactionHash&#39;],&quot;NFT ID&quot;);
    } catch (error) {
      console.error(&quot;Error: &quot;+error);
    }
  }
&lt;/script&gt;
&lt;form onsubmit=&#39;return false;&#39;&gt;
  &lt;p&gt;NFT URI / string: &lt;input type=&#39;text&#39; id=&#39;nftstring&#39; style=&quot;width:200px&quot;&gt;
  &lt;input type=&#39;button&#39; value=&quot;mint&quot; onClick=&quot;mintNFT();&quot;&gt;&lt;/p&gt;
&lt;/form&gt;</code></pre>
<p>This calls a <code>showReturnIntegerValue()</code> function, which is provided below.</p>
<p><img src="metamask-confirmation.webp" style="float:right;border:1px solid black;margin-left:15px"></p>
<p>There is a lot going on here, and you will need to understand it in order to be able to adapt it for the other function calls that you need to make.</p>
<ul>
<li>Notice that we are using the <code>web3mm</code> connection, since we are connecting through MetaMask.</li>
<li>All addresses need to be in checksummed form, else you will get errors. That is what <code>web3mm.utils.toChecksumAddress()</code> does</li>
<li>We are also using the <code>nftContractmm</code> contract, which would have had to be created through the <code>web3mm</code> connection.</li>
<li>We define the <code>mintNFT()</code> function which is an <code>async</code> function; <code>async</code> functions were described in the <a href="../daoweb3/index.html">DAO &amp; web3</a> (<a href="../daoweb3/index.md">md</a>) assignment.</li>
<li>One way to deal with <code>async</code> functions is to give it a code block to execute when the function returns. The other is to have it to wait until the <code>async</code> function returns. We chose the latter here by putting the <code>await</code> keyword in front of the various <code>async</code> calls in that function. Note that <code>await</code> can ONLY be called in an <code>async</code> function (and in one other situation that does not apply to us here); this is a Javascript restriction. Also note that any variable that you <code>await</code> for a value for must be a <code>const</code>.
<ul>
<li>The other way to deal with <code>async</code> functions is to provide it a code block to execute via <code>.then()</code> – an example of that is given below (in the “Hints” section)</li>
</ul></li>
<li>To get the user’s coinbase account address, we call <code>await web3mm.eth.getCoinbase();</code> – that’s the account they are logged into via MetaMask.</li>
<li>The <code>nftContractmm.methods.mintWithURI(str)</code> line is where the transaction itself occurs. You will notice that this uses <code>send()</code>, not <code>sendTransaction()</code>. So this is similar to the <a href="../../docs/geth_reference.html">geth commands we know</a> (<a href="../../docs/geth_reference.md">md</a>), but just different enough to drive us up the wall learning a slightly different syntax for how to call the transaction.</li>
<li>For this assignment, keep the gas at 1 million and the gas price at 1 gwei (which is <span class="math inline">10<sup>9</sup></span> wei); yes, this is a lot of gas, but since our ETH is free, we aren’t worried about it.</li>
<li>Looking at the form, we see that the text box has an ID of <code>nftstring</code> (3rd line from the bottom). The <code>document.getElementById('nftstring').value</code> gets the value currently entered into the text box.</li>
<li>After <code>await</code>ing for the various function calls, we then display the results via an alert box: <code>showReturnIntegerValue(web3mm,txninfo['transactionHash'],"NFT ID");</code>. This function is described below, but it will get the integer return value of a transaction and display that in an alert box. A full fledged website would have a better UI for displaying this, but an alert box is sufficient for us. We assume the user will remember his/her NFT ID, and we do not have to handle the case when they forget it.</li>
<li>We put everything into a try-catch clause, as this will allow printing out of the error if one occurs. You can view that in the Javascript developer console.</li>
<li>In the form, you will notice that the form tag has the value <code>onsubmit='return false;'</code>. We want this entire web page to do all the work, and we are not submitting a form (which will reload the page). This clause prevents the pressing of the Enter key triggering a form submission (and thus page reload).</li>
<li>Also in the form, the button has <code>onClick="mintNFT();"</code> which will launch the <code>mintNFT()</code> Javascript function when it is clicked.</li>
<li>If you are familiar with HTML, you will notice that there is no <code>submit</code> button, as we do not want the form to be submitted (and cause a reload). If you are not familiar with HTML, and don’t know what that means, you can ignore this bullet point.</li>
</ul>
<p>When this Javascript function is called, MetaMask will pop up a window, such as what is shown to the right, to verify that you really want to send that transaction. This happens on the <code>auctionContract.methods.mintNFT(str)</code> line, since that’s the only line that is actually <em>sending</em> a transaction; the other lines are doing read-only calls. You will have to click ‘confirm’ for the transaction to be sent to the blockchain.</p>
<p>Once it is confirmed, it will take a second or so for the transaction to reach the P2P network, and then a second or two for it to be auto-mined into the blockchain. However, MetaMask can take a while (5-10 seconds) to realize that the transaction has occurred. So it can easily take a while for the pop-up window to appear, and then for the result of the transaction to be displayed.</p>
<h4 id="getting-the-return-value-of-a-transaction">Getting the return value of a transaction</h4>
<p>It is surprisingly hard to get the return value of a transaction. Getting one from a call is easy – but for a transaction you have to have the EVM re-run the transaction and then save the return value. You also have to tell it what state to run the EVM in (meaning what block number to assume is the top block). To save you the hassle of figuring out the syntax for all of this, below is a Javascript function you can use.</p>
<p>When you call a transaction, your code will be something like what was above: <code>const txninfo = await nftContractmm.methods.mintWithURI(str).send(...)</code>. The <code>txninfo</code> has <em>some</em> information about the transaction, but not a lot, since it may have not been mined yet (sometimes it returns before it was mined, sometimes after). You can access the transaction hash via <code>txninfo['transactionHash']</code>.</p>
<pre><code>function showReturnIntegerValue(w3,txnhash,desc) {
  w3.eth.getTransaction(txnhash).then(txn =&gt; {
    if ( txn[&#39;blockNumber&#39;] == null ) {
      await new Promise(resolve =&gt; setTimeout(resolve, 1000));
      showReturnIntegerValue(w3,txnhash,desc);
    } else
      w3.eth.call({to:txn[&#39;to&#39;],from:txn[&#39;from&#39;],data:txn[&#39;input&#39;],gas:txn[&#39;gas&#39;]},txn[&#39;blockNumber&#39;]-1).then(retval =&gt; {
      var num = BigInt(retval).toString();
      console.log(num)
      alert(desc+&quot;: &quot;+num);
    });
  });
}</code></pre>
<p>The <code>showReturnIntegerValue()</code> function will display an alert box (and print it to the Javascript console, as long NFT IDs are hard to copy from an alert box) the return value from the transaction. This assumes that it did not revert (your call to <code>startAuction()</code> should be a try-catch block), and that the smart contract function return value is an integer. So this function is intended for both minting an NFT (which returns the <code>uint</code> of the NFT ID) and starting an auction (which returns the ID of the auction). The first parameter is the web3 connection (use the MetaMask one), the second parameter is the transaction hash to get the return value of, and the third parameter is a descriptive message. For example:</p>
<pre><code>showReturnIntegerValue(web3mm,txninfo[&#39;transactionHash&#39;],&quot;NFT ID&quot;);</code></pre>
<p>This will show a pop-up alert box that states something such as “NFT ID: 12345”.</p>
<h3 id="the-task">The Task</h3>
<p><img src="final-web-page.webp" style="float:right;border:1px solid black;margin-left:15px"></p>
<p>Finally! We can get to the whole reason for this party.</p>
<p>Your task is to create a web interface to your Auctioneer.sol contract, which fulfills the <a href="IAuctioneer.sol.html">IAuctioneer.sol</a> (<a href="IAuctioneer.sol">src</a>) interface. The intent is that you start with the existing web page to view the auctions – the link is on the Canvas landing page – and put your modifications at the bottom of that page. Our web page looked like the image to the right; this is the bottom of our web page, and the auction table itself was above what is shown. Yours need not look the same, but it does need to be usable. Specifically, we are <em>not</em> grading on appearance, just usability.</p>
<p>Your web page still has to display the table of auctions <em>in addition to</em> the forms to interact with the IAuctioneer. The auctions table display is intended to be copied from the auctions.php page.</p>
<p>As you are starting with the web site that was provided to you in the <a href="../auction/index.html">dApp Auction</a> (<a href="../auction/index.md">md</a>) assignment (see above for starting on that), the read-only parts of this assignment are already done for you. You will have to change the contract IDs, of course – you should hard-code that into your HTML / Javascript code (just replace the address that is there – it may be there multiple times). Note: you have to view the original auctions page with an address else most of the relevant Javascript code will not be shown. The link to that page with an address is on the Canvas landing page. We discussed how to create a HTML form interface, and the Javascript code to make it work, above. You will have to hard-code the Auctioneer smart contract address.</p>
<p>For this assignment, you need to create a web interface with three of the Auctioneer functions – <code>startAuction()</code>, <code>closeAuction()</code>, and <code>placeBid()</code>. Your interface also needs to interact with two functions of the NFT manager: <code>mintWithURI()</code> (the one-parameter version, shown above) from <a href="../tokens/NFTManager.sol.html">NFTManager.sol</a> and <code>approve()</code> that was inherited into NFTManager.sol from <a href="../auctions/IERC721.sol.html">IERC721.sol</a>. This means you will have to interact with <strong><em>TWO</em></strong> contracts on the blockchain. Thus, you will need to create a contract interface to your NFTManager contract as well (similar to how <code>auctionContractmm</code> was created) – be sure to use <code>web3mm</code>! You can hard-code the address for the NFTmanager, and you can obtain that by calling <code>nftmanager()</code> on your Auctioneer contract; the former is likely simpler. Note that many of the smart contract function parameters are already known, and need not be entered in the form – the NFT is minted for the MetaMask account, and the transfer assumes it is coming from the same MetaMask account and going to the Auctioneer. So only the NFT ID is what needs to be entered when approving a NFT, for example.</p>
<p>For the <code>placeBid()</code> function, you will have to take in the amount that they want to bid. This should be a floating-point value of the ether to place the bid for, and your Javascript will have to convert that to wei. You may run into rounding issues in Javascript, and those are fine (due to floating-point precision issues, <span class="math inline">1.1 * 10<sup>18</sup> = 1100000000000000100</span>).</p>
<p>The forms for these five functions should be on that same page – in particular, you will only be submitting one page, called <code>metamask_xxxxxxxx.html</code> to Gradescope. You can put those forms on the bottom, along with the MetaMask connect button described above. As with the <a href="../daoweb3/index.html">DAO &amp; web3</a> (<a href="../daoweb3/index.md">md</a>) assignment, since this is not a course in user interfaces, it will not be graded on it’s beauty. But it still has to be usable.</p>
<p>Any calls the three Auctioneer functions (<code>createAuction()</code>, <code>closeAuction()</code>, and <code>placeBid()</code>) will have that change reflected in the table of auctions, which will automatically update when an event is emitted. The call to <code>approve()</code> should just display “success” (or similar) via a pop-up box (call <code>alert("success");</code> in Javascript). When <code>mintWithURI()</code> is called, it performs the transaction and then performs a web3.js call to get the NFT ID via <code>showReturnIntegerValue()</code>, described above, which is then displayed via an alert box.</p>
<p>When this assignment is complete, anybody should be able to create NFTs, initiate auctions, bid on existing auctions, and close auctions when they are done. As for the NFT images, we will still provide just a file name, and the URL prefix will be the same URL link as in the <a href="../tokens/index.html">Ethereum Tokens</a> (<a href="../tokens/index.md">md</a>) assignment; that prefix is on the Canvas landing page from the Tokens assignment.</p>
<p><br clear='all'></p>
<h3 id="web-page-setup">Web page setup</h3>
<p>To get the metamask_xxxxxxxx.html web page set up:</p>
<ul>
<li>Get the contract address of your deployed Auctioneer.sol contract</li>
<li>Go to the auctions.php web site (the address is on the Canvas landing page), and enter that smart contract address to view those auctions
<ul>
<li>You have to view that page with an address else most of the relevant Javascript code will not be shown. The link to that page with an address is on the Canvas landing page.</li>
</ul></li>
<li>Ensure that the resulting page does not display any errors (view the console in the developer tools)</li>
<li>View the source of the web page</li>
<li>Save that into metamask_xxxxxxxx.html</li>
<li>Deploy metamask_xxxxxxxx.html to your account on the departmental server in your <code>~/public_html/</code> directory</li>
<li>View that page – ensure it shows the same result, and also has no errors</li>
<li>To make your code more readable, you can use the “reduced” ABIs – these have just the functions that are used in this assignment, as well as the functions that the existing auctions.php page uses: <a href="IAuctioneer.abi.txt">IAuctioneer.abi</a> for <code>auctioneerAbi</code> and <a href="INFTManager.abi.txt">INFTManager.abi</a> for <code>nftManagerAbi</code>. You can also use the full ABIs: <a href="IAuctioneer-full.abi.txt">IAuctioneer-full.abi</a> and <a href="INFTManager-full.abi.txt">INFTManager-full.abi</a></li>
<li>Add the code provided above:
<ul>
<li>The declaration of the <code>web3mm</code> variable and the <code>auctionContractmm</code> variable</li>
<li>The code to ensure MetaMask is installed</li>
<li>The code to connect to Ethereum</li>
<li>The provided <code>showReturnIntegerValue()</code> Javascript function</li>
<li>The code for the Javascript function and the form</li>
</ul></li>
<li>Redeploy and then reload the page, and mint a new NFT – it should mint it properly, and without any errors. You should be able to view that transaction on the explorer (look at the list of transactions for your account).</li>
</ul>
<h3 id="hints">Hints</h3>
<h4 id="javascript-developer-console">Javascript developer console</h4>
<ul>
<li>You will need to use the Javascript console in the developer tools. There is no other way to debug this.</li>
<li>Use <code>console.log()</code> to print out the values of various variables are you are debugging your code.</li>
<li>The default settings for the Javascript development console in Chrome are <em>not</em> to display all the messages. This means that <code>console.log()</code>, and other error messages, will not appear. Make sure there is no filter set (it’s in the top toolbar in the Javascript console). Also, to the immediate right of the filter box, ensure that all the values are checked in the “levels” drop-down list. See <a href="https://stackoverflow.com/questions/18760213/chrome-console-log-console-debug-are-not-working">here</a> for some more hints on this topic.</li>
<li>In the Javascript console, once the page is loaded, you can access the variables right from the Javascript console prompt, and then call functions on them.</li>
<li>If you are calling an <code>async</code> function, you should use <code>await</code>, such as: <code>await auctionContractmm.methods.startAuction(...)</code>.</li>
<li>In the Javascript console, to ensure you are connected, you can check if the <code>eth.coinbase</code> addresses are available: <code>await web3mm.eth.getAccounts()</code>.</li>
</ul>
<h4 id="web3.js-programming">Web3.js programming</h4>
<ul>
<li>If you need to checksum an address in Javascript via web3.js, call <code>web3.utils.toChecksumAddress()</code>. All addresses will have to be checksummed, else it will give you an ‘invalid sender’ error. This includes any <code>to</code> or <code>from</code> addresses in any and all transaction calls.</li>
<li>Be sure to set your gas correctly, else it will revert because of insufficient gas (the explorer can detect when it reverts for this reason). The gas price should be set to 1 gwei (<span class="math inline">10<sup>9</sup></span> wei). The most expensive operation you are going to perform is likely <code>startAuction()</code>, which could use 250k gas. So set your startGas amounts to 1 million, and you’ll be fine.
<ul>
<li>Note that Metamask will estimate how your transaction is going to cost based on the gas price, the <em>full</em> amount of the startGas (since it doesn’t know how much it will really take), and the <em>current</em> price of ether. Thus, it could estimate fees well over $100.</li>
</ul></li>
<li>When you configured your account, you entered the explorer URL – this was in step 3 in the “MetaMask setup” section, above. This allows you to click on any transaction or account, and it will pull up the appropriate page in the course blockchain explorer. Some of these will report as “view on Etherscan”, but it will really lead to our blockchain explorer when you click on it.</li>
</ul>
<!--

### Calling a smart contract function

Unlike web3.js, it's more difficult (read: annoying) to call a function via MetaMask.  Consider this Javascript code from the [MetaMask page on sending transactions](https://docs.metamask.io/guide/sending-transactions.html#example):

```
const transactionParameters = {
  nonce: '0x00', // ignored by MetaMask
  gasPrice: '0x09184e72a000', // customizable by user during MetaMask confirmation.
  gas: '0x2710', // customizable by user during MetaMask confirmation.
  to: '0x0000000000000000000000000000000000000000', // Required except during contract publications.
  from: ethereum.selectedAddress, // must match user's active address.
  value: '0x00', // Only required to send ether to the recipient from the initiating external account.
  data:
    '0x7f7465737432000000000000000000000000000000000000000000000000000000600057', // Optional, but used for defining smart contract creation and interaction.
  chainId: '0x3', // Used to prevent transaction reuse across blockchains. Auto-filled by MetaMask.
};

// txHash is a hex string
// As with any RPC call, it may throw an error
const txHash = await ethereum.request({
  method: 'eth_sendTransaction',
  params: [transactionParameters],
});
```

This is the Javascript code that will have to be run, in some function that you define, in order to execute a transaction.  MetaMask has already connected to the blockchain and unlocked the account, so you can directly make the transaction as shown above.

For this assignment:

- `nonce`: MetaMask ignores this, so just putting `0x00` is fine
- `gasPrice`: We are going to use a fixed 10 gwei, like we did in the [Arbitrage trading](../arbitrage/index.html) ([md](../arbitrage/index.md)) assignment.  10 gwei is $10 \ast 10^{18}$ wei, which is 0x2540be400 in hex.
- `gas`: Since our (fake) ETH is free, you can put a large value, such as 100,000 here (which is 0x186a0 in hex).  In practice we would perform a gas estimate, like we did in the [Arbitrage trading](../arbitrage/index.html) ([md](../arbitrage/index.md)) assignment.
- `to`: That's your smart contract's address.
- `from`: That's obtained from the MetaMask extension, and the `ethereum.selectedAddress` will do that for you.
- `value`: How much ether, expressed in wei, you are sending in with this function call.  Note that this must also be in hex!
- `data`: This is the hex code to call the function on the smart contract.  How to encode that is described in the [function call encoding tutorial](../docs/function_call_encoding.html) ([md](../docs/function_call_encoding.md)).
- `chainId`: Apparently filled in by MetaMask, but the value for our course chain is on the Canvas landing page.

Once those parameters are set correctly, the last four lines in the above code will call that function.

-->
<h3 id="common-errors">Common Errors</h3>
<ul>
<li>“Invalid sender” error when you are submitting a transaction: while there are lots of things that could cause this, you will want to check that your chain ID is set correctly. Click on the MetaMask fox icon (<img src="metamask-fox.svg" style="max-height:20px;vertical-align:middle">), then the circular account icon in the top right (<img src="metamask-account-icon.webp" style="max-height:20px;vertical-align:middle">, although your may look different), then Settings, then Networks, then click on the “localhost:8545” network. Make sure the chain ID is set correctly; it’s on the Canvas landing page, if you forget what it is. It should be set using it’s base-10 value.</li>
<li>MetaMask RPC error / Header not found. If you get the following error: <code>"[ethjs-query] while formatting outputs from RPC '{"value":{"code":-32603,"data":{"code":-32000,"message":"header not found"}}}'"</code>, try switching your network to Mainnet and then back to localhost:8545, as some have reported that this fixes the issue.</li>
<li>If MetaMask suddenly stops appearing to send your transactions, they may have gotten “stuck”. Each successive Ethereum transaction must have the next highest nonce. If there is a gap, then it will queue the transaction until the gap is resolved. If you send to many transactions at once, they could arrive out of order. To resolve this, since everything here is free, spam some transactions (not calls) to the blockchain. Calling <code>collectFees()</code> a bunch of times from an Auctioneer contract will do the trick.</li>
</ul>
<h3 id="grading">Grading</h3>
<p>The grades on this are going to be rather binary – if it works, then full (or close to full) credit. If it doesn’t work, then very little or no credit. In particular, there will be very little partial credit awarded on this assignment. This assignment is graded by a human; it cannot be auto-graded.</p>
<h3 id="submission">Submission</h3>
<p>You will need to fill in the various values from this assignment into the <a href="metamask.py.html">metamask.py</a> (<a href="metamask.py">src</a>) file. That file clearly indicates all the values that need to be filled in. That file, along with your Solidity source code, are the only files that must be submitted. The ‘sanity_checks’ dictionary is intended to be a checklist to ensure that you perform the various other aspects to ensure this assignment is fully submitted.</p>
<p>There are <em>four</em> forms of submission for this assignment; you must do all four.</p>
<p>Submission 1: You should submit your <code>metamask_xxxxxxxx.html</code> file, along with your completed <code>metamask.py</code> file, to Gradescope. In particular, you are NOT submitting any Solidity code for this assignment. <strong>NOTE:</strong> Gradescope cannot fully test this assignment, as it does not have access to the private blockchain. So it can only do a few sanity tests (correct files submitted, successful compilation, valid values in metamask.py, etc.).</p>
<p>Submission 2: You must deploy your Auctioneer smart contract to our private Ethereum blockchain, or you can also use the one you deployed from the <a href="../auction/index.html">dApp Auction</a> (<a href="../auction/index.md">md</a>) assignment. It’s fine if you deploy it a few times to test it. The smart contract address for this needs to be the same as the one in your submitted <code>metamask_xxxxxxxx.html</code> file.</p>
<p>Submission 3: You need to have your metamask_xxxxxxxx.html properly working at https://www.cs.virginia.edu/~mst3k/metamask_xxxxxxxx.html, where <code>mst3k</code> is your userid. This means it needs to be in your <code>~/public_html</code> directory on the departmental servers. You should have web.js (or web3.min.js) in that website directory, which you probably have from the <a href="../daoweb3/index.html">DAO &amp; web3</a> (<a href="../daoweb3/index.md">md</a>) assignment. Needless to say, it should properly connect to your deployed Auctioneer smart contract.</p>
<p>Submission 4: You need to mint a few NFTs and start a few auctions. You should start three auctions using the NFT images that you created for the <a href="../auction/index.html">dApp Auction</a> (<a href="../auction/index.md">md</a>) assignment. The start and end dates, number of bids, and reserve does not matter for these auctions.</p>
</body>
</html>
