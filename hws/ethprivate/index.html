<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Connecting to the private Ethereum Blockchain</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="../../markdown.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="connecting-to-the-private-ethereum-blockchain">Connecting to the
private Ethereum Blockchain</h1>
<p><a href="../index.html">Go up to the CCC HW page</a> (<a
href="../index.md">md</a>)</p>
<h3 id="overview">Overview</h3>
<p>We will be developing applications for the Ethereum blockchain. We
won’t be using the actual Ethereum blockchain for a number of reasons
(cost, legal issues, speed, etc.). Instead, we are going to use a
private Ethereum blockchain – a test network – that has been set up for
this class. This assignment is to connect to it, explore it, and perform
a few operations.</p>
<h3 id="pre-requisites">Pre-requisites</h3>
<p>This document assumes that you have a recent version of Python 3
installed, and that you can install Python packages through pip (or
pip3). This is already taken care of in the VirtualBox image. Don’t
worry if you don’t know Python – we give you the exact code to use.</p>
<p>This document also assumes you can install packages on your machine
(also not needed for the VirtualBox image).</p>
<h3 id="part-1-install-geth">Part 1: Install geth</h3>
<p>This is already taken care of in the VirtualBox image, and you can
skip to step 2 if you are using the VB image.</p>
<p>You will need to <a
href="https://geth.ethereum.org/docs/install-and-build/installing-geth">install
geth</a>. The instructions differ depending on your OS.</p>
<p>Geth, which stands for Go Ethereum, is a command-line interface to
run an Ethereum node. This particular implementation is written in the
Go programming language.</p>
<p><strong>WARNING:</strong> DO NOT JUST RUN <code>geth</code>! Doing so
will connect to the default Ethereum network, and will proceed to
download the ENTIRE Ethereum blockchain, which is around 500 Gb for a
“light” node and 1 Tb for a “full” node. It also takes a full week to
synchronize all that data.</p>
<h3 id="part-2-connect-to-the-private-blockchain">Part 2: Connect to the
private blockchain</h3>
<p>Step 1: Create a data directory to hold the blockchain info – this
can be anywhere you want, but we’ll call it
<code>/path/to/ethprivate</code> herein.</p>
<p>Step 2: In that data directory, copy the <a
href="genesis.json">genesis.json</a> file in this repo to that
directory. This file lists the parameters for our private blockchain
(the difficulty, the chain ID, etc.). It has the following contents:</p>
<pre><code>{
        &quot;config&quot;: {
                &quot;chainId&quot;: 12345678,
                &quot;homesteadBlock&quot;: 0,
                &quot;eip150Block&quot;: 0,
                &quot;eip155Block&quot;: 0,
                &quot;eip158Block&quot;: 0
        },
        &quot;difficulty&quot;: &quot;0x400&quot;,
        &quot;gasLimit&quot;: &quot;0x8000000&quot;,
        &quot;alloc&quot;: {}
}</code></pre>
<p>Step 3: You have to change the <code>chainId</code> value on that
line. The value we are using for our class is listed in the Collab
workspace’s landing page. Nothing herein will work properly if you don’t
change that value!</p>
<p>Step 4: Initialize geth to use that network with the following
command (you have to change three things before you run it):</p>
<pre><code>geth --identity &quot;mst3k&quot; --datadir /path/to/ethprivate/ init /path/to/ethprivate/genesis.json</code></pre>
<p>What you have to change in that command:</p>
<ul>
<li>For the identity, replace mst3k with your userid. That’s the node
identity, and it will be easier to figure out who is who when it’s based
on the userid rather than, say, your computer’s hostname.</li>
<li>In two places, replace <code>/path/to/ethprivate</code> with the
path to your actual data directory. You should about a dozen lines of
output, and the last one should say “Successfully wrote genesis state”.
If not, then this needs to be fixed before continuing.</li>
</ul>
<p>Step 5: Create a <code>geth/static-nodes.json</code> file in your
data directory. The <code>geth/</code> sub-directory will have been
created by the previous step. This file lists a static node so you can
connect to the our blockchain – one of the servers for this course will
be used for this purpose. As we don’t want to make that public, you can
find that file linked to from the Collab landing page. Make sure it goes
into the <code>geth/</code> sub-directory!</p>
<p>Step 6: Start geth. Run the following command, changing the data
directory to your own, and changing the networkid value to the
<code>chainId</code> that you set in the genesis.json file, above.</p>
<pre><code>geth --datadir /path/to/ethprivate --networkid 12345678 --maxpeers 1</code></pre>
<p>Once running, it should list a peer count (on the right) of at least
1. It will take a minute or so for that to happen. Assuming it does, you
are now connected our private Ethereum blockchain!</p>
<h3 id="part-3-explore-geth">Part 3: Explore geth</h3>
<p>What is running from part 2 is the Ethereum node, but that is not
interactive. You should leave it running while you perform the next few
parts of this assignment.</p>
<p>To enter commands via the keyboard, you have to “attach” to the local
Ethereum node. You do this by entering the following command:</p>
<pre><code>geth attach /path/to/geth.ipc</code></pre>
<p>This has to be run in the data directory you created above, as that
is where the geth.ipc file is (or you can enter the full path of the
geth.ipc file). If you are in the same directory as geth.ipc, you may
have to enter <code>./geth.ipc</code> as the file name. Note that this
won’t work unless the geth node, from the previous step, is running. You
will then get a command prompt, which is just a greater-than sign. This
is a JavaScript interpreter.</p>
<p>First, let’s wait for it to sync. Since you have saved the
static-nodes.json file, it will connect to the course server and start
downloading all the blocks in the blockchain. This may take some time,
but hopefully less than 5 minutes.</p>
<p>As it is sync’ing, you can try these commands:</p>
<ul>
<li><code>eth.blockNumber</code> will return the highest block number in
the blockchain that is on your computer. If it is returning zero, then
it is not sync’ed (or is not syncing at all).</li>
<li><code>eth.syncing</code> will either return ‘false’ if it is not
syncing, or a JSON dictionary if it is.
<ul>
<li>if <code>eth.blockNumber</code> is (much) greater than 0 and
<code>eth.syncing</code> is false, then it is not sync’ing, perhaps due
to a networking connection issue. This will always be the case right
after geth starts and before it has had a chance to connect to
peers.</li>
<li>if <code>eth.syncing</code> is false but
<code>eth.blockNumber</code> is non-zero, then it has completed
syncing.</li>
<li>if <code>eth.syncing</code> returns a JSON dictionary, then it is in
the process of sync’ing.
<ul>
<li>The <code>currentBlock</code> value, aka
<code>eth.syncing.currentBlock</code> is the highest block it has
sync’ed so far; this is also the value that <code>eth.blockNumber</code>
returns</li>
<li>The <code>highestBlock</code> value, aka
<code>eth.syncing.highestBlock</code>, is what it is working on sync’ing
to</li>
<li>Once <code>currentBlock</code> reaches <code>highestBlock</code>,
then the sync’ing will be complete</li>
</ul></li>
<li>you can use this command to print out the syncing status:
<code>console.log ("at " + eth.blockNumber + " of " +
eth.syncing.highestBlock + " blocks; " +
(eth.syncing.highestBlock-eth.blockNumber) + " blocks left to
sync")</code></li>
</ul></li>
<li><code>admin.peers.length</code> will tell you how many peers you are
connected to – it should be at least 1. Because you ran it with the
<code>--maxpeers 1</code>, it probably won’t be greater than 1. If you
enter this right after you start up geth, it may return 0, as it is
still connecting to the peer(s).</li>
<li><code>admin.peers</code> will print information on each of those
peers. Once established, it should list exactly one peer – the course
server, whose ‘enode’ specification is the same as the static-nodes.json
file that you downloaded.</li>
</ul>
<p>Once it is sync’ed, here are some commands for you to try out:</p>
<ul>
<li><code>personal.newAccount()</code> will generate an Ethereum account
for you. You SHOULD enter password – if you leave the password field
blank, then anybody in the class can use your account. It will give you
an account address back, such as
0x0123456789abcdef0123456789abcdef01234567. Let’s only create one
account for now!</li>
<li>You can check the balance in your account by
<code>eth.getBalance("0x0123456789abcdef0123456789abcdef01234567")</code>
– it should be zero at this point</li>
<li>To get money into the account, we need to mine some ETH. As the
difficulty was set very low (as per the genesis.json file, above), we
can use the CPU. To do this, run <code>miner.start()</code></li>
<li>Let that run for a little while – say 10 seconds or so – and then
run <code>miner.stop()</code>
<ul>
<li>YOU CANNOT LEAVE THE MINER RUNNING ON THE DEPARTMENTAL MACHINES</li>
<li>Note that each successfully mined block adds 2 ETH to your
account</li>
</ul></li>
<li><strong>DO NOT MINE EXCESSIVELY!!!</strong> You don’t need very much
(fake) ETH for this course. 100 ETH or so is more that enough. It’s okay
if you have more, but I don’t want to see any accounts with thousands or
millions of ETH; that will make me very cranky. And if you mine
excessively, then two bad things will happen:
<ol type="1">
<li>The block chain will dramatically increase in size, which will just
make it take longer for everybody else to sync</li>
<li>The difficulty will go up, which will make it harder for everybody
else to mine</li>
</ol></li>
<li>Check your balance again – it will list some insanely high number,
such as 80000000000000000000. You are rich!!!
<ul>
<li>Not really. That’s in wei, which is <span
class="math inline">10<sup>18</sup></span> of an ETH. So that’s really
80 ETH. Which would still be worth a lot, but this is our private
network, so it’s still worth $0.</li>
<li>You can get your account balance in ETH via
<code>web3.fromWei(eth.getBalance(eth.coinbase), "ether")</code></li>
</ul></li>
<li>Get the current block number: <code>eth.blockNumber</code>. Note
that other people may be doing this at the same time, so the block
number may be higher than what you expected due to your mining.</li>
<li>You can list your accounts via <code>eth.accounts</code> – it will
likely only list the one you created above</li>
</ul>
<h3 id="part-4-extract-private-key">Part 4: Extract private key</h3>
<p>We need to get the private key of the account you created, as we will
need that later for our dApp development later on. The private key is
encrypted in a .json file in the keystore/ sub-directory of your geth
data directory. It will have a name like:
UTC–2022-01-08T19-53-08.823103866Z–0123456789abcdef0123456789abcdef01234567.
Note that the last part of that name
(“0123456789abcdef0123456789abcdef01234567”) matches the Ethereum
address we obtained above.</p>
<p>First, ensure that the <code>web3</code> Python package is installed
– run <code>pip install web3</code> or <code>pip3 install web3</code>.
This is already installed on the VirtualBox image, so you can skip this
step if you are using VB.</p>
<p>Run python (or python3, depending on your OS). In Python, enter the
following two lines, changing the values as appropriate to the file name
(with full path) and the password for the Ethereum account you created
in geth:</p>
<pre><code>password=&quot;password&quot;
filename=&quot;/path/to/ethprivate/keystore/UTC--2022-01-08T19-53-08.823103866Z--0123456789abcdef0123456789abcdef01234567&quot;</code></pre>
<p>Next, cut-and-paste the following code into your Python
terminal.:</p>
<pre><code>from web3.auto import w3
keyfile = open(filename)
encrypted_key = keyfile.read()
private_key = w3.eth.account.decrypt(encrypted_key,password)
import binascii
binascii.b2a_hex(private_key)</code></pre>
<p>When you run it, it will look like the following:</p>
<pre><code>$ python3
Python 3.8.10 (default, Nov 26 2021, 20:14:08) 
[GCC 9.3.0] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; password=&#39;&#39;
&gt;&gt;&gt; filename=&#39;path/to/ethprivate/keystore/UTC--2022-01-08T19-53-08.823103866Z--0123456789abcdef0123456789abcdef01234567&#39;
&gt;&gt;&gt; from web3.auto import w3
&gt;&gt;&gt; keyfile = open(filename)
&gt;&gt;&gt; encrypted_key = keyfile.read()
&gt;&gt;&gt; private_key = w3.eth.account.decrypt(encrypted_key,password)
&gt;&gt;&gt; import binascii
&gt;&gt;&gt; binascii.b2a_hex(private_key)
b&#39;0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef&#39;
&gt;&gt;&gt; 
$</code></pre>
<p>The private key is the hex line at the end – you should remove the
leading <code>b'</code> and trailing <code>'</code>.</p>
<p>Save this private key somewhere, as you will need it in future
assignments. Normally we would never save this in plaintext, but the ETH
on this system are still worth $0.</p>
<h3 id="part-5-send-me-some-money">Part 5: Send me some money!!!!</h3>
<p>Next you are going to send me some money via the geth command line.
To send ETH, you have to first unlock your account:</p>
<pre><code>personal.unlockAccount(&quot;0x0123456789abcdef0123456789abcdef01234567&quot;);</code></pre>
<p>This will prompt you for your password. You have to replace the
address shown with your account address (via
<code>eth.accounts</code>);</p>
<p>You can also use <code>eth.coinbase</code>, which should be the same
account. By default it unlocks for 5 minutes; you can unlock it until
geth exits via: <code>personal.unlockAccount(eth.coinbase, "password",
0)</code></p>
<p>You can then send me 1 ETH:</p>
<pre><code>eth.sendTransaction({from:&#39;0x0123456789abcdef0123456789abcdef01234567&#39;, to:&#39;0xffffffffffffffffffffffffffffffffffffffff&#39;, value:web3.toWei(1,&quot;ether&quot;), gas:21000});</code></pre>
<p>You have to replace the ‘from’ field with your address (or
<code>eth.coinbase</code>), and the ‘to’ field with my address. My
address can be found on the Collab landing page. This will print out a
hex string – save it! That’s the hash of the transaction, and we’ll need
it shortly. It will be something like:
0xabcdefabcdefabcdefabcdefabcdefabcdefabcdefabcdefabcdefabcdefabcd.</p>
<p>Further steps to do in the geth console:</p>
<ul>
<li>Check your balance via
<code>eth.getBalance("0x0123456789abcdef0123456789abcdef01234567")</code>
– you will notice that the balanace has not changed, since the
transaction was not mined into a block. Get the block number by
<code>eth.blockNumber</code></li>
<li>You can see your pending transaction via
<code>eth.pendingTransactions</code>
<ul>
<li>Note that if others in the class are doing this at the same time, it
may have been mined before you could check the pending transactions</li>
</ul></li>
<li>Start mining via <code>miner.start()</code>, wait 5-10 seconds, and
then stop mining via <code>miner.stop()</code>.</li>
<li>Check your balance via <code>eth.getBalance(eth.coinbase)</code> and
the block number by <code>eth.blockNumber</code>. You will notice you
have more money than before, but no longer a multiple of 5 (the amount
mined per block) – you will have 1 less than a multiple of 2, since you
just sent me 1 ETH. Also notice that the mining process did not deduct
gas fees.</li>
<li>You can also get your account balance in ETH via:
<code>web3.fromWei(eth.getBalance(eth.coinbase), "ether")</code></li>
<li>Get information on the mined transaction:
<code>eth.getTransactionReceipt("0xabcdefabcdefabcdefabcdefabcdefabcdefabcdefabcdefabcdefabcdefabcd")</code>
– replace the hash there with the transaction hash you recorded, above.
<ul>
<li>Note the block number, which you will have to submit along with the
transaction hash</li>
</ul></li>
</ul>
<h3 id="part-6-explore-geth-on-your-own">Part 6: Explore geth on your
own</h3>
<p>You should explore geth on your own. When you start geth (via
<code>geth attach geth.ipc</code>), it lists the modules available:</p>
<pre><code>Welcome to the Geth JavaScript console!

instance: Geth/v1.10.15-stable-8be800ff/linux-amd64/go1.17.5
coinbase: 0x0123456789abcdef0123456789abcdef01234567
at block: 52 (Sat Jan 08 2022 21:49:04 GMT-0500 (EST))
 datadir: /home/crypto/ethprivate
 modules: admin:1.0 debug:1.0 eth:1.0 ethash:1.0 miner:1.0 net:1.0 personal:1.0 rpc:1.0 txpool:1.0 web3:1.0

To exit, press ctrl-d or type exit
&gt; </code></pre>
<p>The modules are listed on the 7th line (admin, debug, eth, ethash,
miner, net, personal, rpc, txpool, and web3). In the console, type the
start of the module, a period, and hit the Tab key – it will show you
all the possible completions. If you type in the name and it’s a
function, it will tell you that. And if you try to run the function with
no parameters, and it needs parameters, it will tell you that as well.
Lastly, it’s a JavaScript console, so you can use any JavaScript
programming, if you happen to know JavaScript. (You won’t need to know
JavaScript for this course).</p>
<p>You are also welcome to mine more ETH into your account, but please
don’t go crazy – if there is too much mining, it will make the
difficulty harder, which will cause problems when other students want to
mine their own ETH.</p>
<h3 id="part-7-blockchain-explorer">Part 7: Blockchain Explorer</h3>
<p>We have a web-based blockchain explorer for our private Ethereum
blockchain. The link to that is on the Collab landing page. Browse that
site, and play around with the search functionality. Directions for how
to use it are on the main page. Note that the site updates every 5
minutes, so if you make a transaction, it will not be immediately
visible there – the time of the last update is listed on the main page
(the bottom bullet under ‘Statistics’).</p>
<p>Find the web page that contains the transaction (not the block!)
where you send me the 1 (fake) ETH; you will need to submit this
URL.</p>
<h3 id="closing-down">Closing down</h3>
<p>If you are not actively using it, you should shut your geth node
down. ITS has given me permission to do all this, but they do perform
port scans on all machines, so no need to raise hackles by keeping a
geth node up and running. You can easily re-launch it when you need it
again for a future assignment. Likewise for the console from part (3);
if you close down the geth node, the console won’t work.</p>
<h3 id="submission">Submission</h3>
<p>You will need to submit your information via a Google form, the link
to which is on the Collab landing page. You will need to submit the
following items:</p>
<ul>
<li>Your Ethereum account number from part (3). Note that this is public
information.
<ul>
<li>We are NOT asking for the private key from part (4) – even though
it’s not worth anything, you should always be in the habit of never
sharing private keys.</li>
</ul></li>
<li>The transaction ID when you sent me the ETH in part (5)</li>
<li>The block number that the mined transaction, from part (5), where
you sent me some ETH</li>
<li>The URL to the page that contains the transaction (not the block!)
where you sent me 1 (fake) ETH, from part (7)</li>
</ul>
</body>
</html>
