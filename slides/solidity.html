<!doctype html>
<html lang="en">
  <head>
    <base target="_blank">
    <meta charset="utf-8">
    <title>CCC: Cryptocurrency Course slide set</title>
    <meta name="description" content="A set of slides for a course on Cryptocurrency">
    <meta name="author" content="Aaron Bloomfield">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <link rel="stylesheet" href="../slides/reveal.js/dist/reset.css">
    <link rel="stylesheet" href="../slides/reveal.js/dist/reveal.css">
    <link rel="stylesheet" href="../slides/reveal.js/dist/theme/black.css" id="theme">
    <link rel="stylesheet" href="../slides/ccc.css">
    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="../slides/reveal.js/plugin/highlight/zenburn.css">
    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? '../slides/reveal.js/css/print/pdf.scss' : '../slides/reveal.js/css/print/paper.scss';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
    <!--[if lt IE 9]>
	<script src="../slides/reveal.js/lib/js/html5shiv.js"></script>
	<![endif]-->
    <style>
.reveal li {
font-size:90%;
line-height:120%;
}
    </style>
  </head>
  <body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

	<section data-markdown><textarea>
# CS 4501
&nbsp;
### Cryptocurrency

<p class='titlep'>&nbsp;</p>
<div class="titlesmall"><p>
<a href="http://www.cs.virginia.edu/~asb">Aaron Bloomfield</a> (aaron@virginia.edu)<br>
<a href="http://github.com/aaronbloomfield/ccc">@github</a> | <a href="index.html">&uarr;</a> | <a href="./03-numbers.html?print-pdf"><img class="print" width="20" src="../slides/images/print-icon.png" style="top:0px;vertical-align:middle"></a>
</p></div>
<p class='titlep'>&nbsp;</p>

## Solidity
	</textarea></section>

	<section data-markdown><textarea>
# Contents
&nbsp;  
[Types](#/types)  
[Concepts](#/concepts)  
[Choices Example](#/choices)  
[Debtor's Example](#/debtor)  
[Testing & Debugging](#/debugging)  
	</textarea></section>

<!-- ============================================================ -->
  
  <section>

    <section id="types" data-markdown class="center"><textarea>
# Types
    </textarea></section>

    <section data-markdown data-separator="^\n\n\n"><textarea>
## Sources
- The main reference for this slide set is the [Solidity language documentation](https://docs.soliditylang.org/en/latest/index.html)
  - URL: https://docs.soliditylang.org/en/latest/index.html
- This section is the [Types section therein](https://docs.soliditylang.org/en/latest/types.html)
  - https://docs.soliditylang.org/en/latest/types.html
  - Many of the examples herein are from there
- Also some code examples from the [Choices.sol](../hws/dappintro/Choices.sol.html) contract from the [dApp introduction](../hws/dappintro/index.html) assignment



## A note about these slides
- These slides are meant as a explanation
  - You are not expected to remember everything!
- Since you all know OOP, it's just showing what is different in Solidity
- You can come back to use this as a reference later



## Value types: integers
- Signed and unsigned ints from 8 bits (1 byte) to 256 bits (32 bytes) in size
  - And in all byte sizes between
- Unsigned: `uint8`, `uint16`, `uint24`, ... `uint256`
  - `uint` is an alias for `uint256`
- Signed: `int8`, `int16`, `int24`, ..., `int256`
  - `int` is an alias for `int256`
- Standard operations (arithmetic, comparisons, bit operators, shift operators)
  - Exponentiation is $\ast \ast$
- `type(int256).max` and `type(uint160).min` for min/max




## Value types: integers
- Most used: `uint` (aka `uint256`) and `uint8`
- Warning: a subtraction into a `uint` that is negative will cause a revert
  - A revert is basically an abort -- more on this later
  - And it will not give a useful error message indicating so!



## Integer literals
- Scientific notation: `1e12` equals $10^{12}$
  - `3.4e8` equals $3.4 \ast 10^8$
- Underscores separate digits for readability, but do not affect its value
  - 0x12345678 == 0x1234_5678



## Other value types
- Booleans: type is `bool`, values are `true` and `false`
- All comparisons evaluate to a Boolean
- Fixed point numbers: not yet fully supported
  - Types are `fixed` and `ufixed`
  - But don't use them!
- No floating point numbers!
- Note that all variables have an initial value of 0



## Addresses
- Types are `address` and `address payable`
- It's just a number: a 160-bit (20 byte) Ethereum address
  - Allows standard comparison operators
- Used for:
  - Keeping track of who is the contract initiator
  - Addresses of other contracts to call
- Can convert between `address` and: `uint160` or `bytes20`
- The address of a caller of a function is in `msg.sender`



## Address examples
- You can convert to a payable address:
  ```
address a;
address payable b = payable(a);
```
- Conversions:
```
uint160 b = uint160(msg.sender);
bytes20 c = bytes20(msg.sender);
```
- More examples:
```
if ( a == address(0) ) { ... }
address initiator = msg.sender;
```



## Address fields
- Although a primitive type, it has fields and methods:
  - `balance`: the balance, in wei, for that address
    ```
address payable x = payable(0x123);
address myAddress = address(this);
if (x.balance < 10 && myAddress.balance >= 10) {...}
```
- Other methods we won't see in this course: 
  - `transfer()` to send wei (requires a `receive()` function on the receiving contract)
  - `send()`: low-level and not safe version of `transfer()`
  - `call()`, `delegatecall()`, and `staticcall()`: calling a contract with an unknown ABI
  - `code()` and `codehash()` to get the bytecode of the contract



## Fixed-sized Arrays
- Fixed sized array of bytes: `bytes1`, `bytes2`, up to `bytes32`
  - The size is the integer in the type name; max of 32 bytes
  - `.length` to get the length
  - Indexing with `[]`
- Operators:
  - Comparisons, bit operators, shift operators
  - Treats the byte array like a similiarly sized `uint` when performing the operation



## Dynamically-sized arrays
- `bytes`: dynamically sized array of bytes
- `string`: dynamically sized array of UTF-8 characters
  - We'll see string functions in a bit...



## String literals
- Strings can be enclosed in single quotes or double quotes
- Can use the backslash for escape characters
- Two strings next to each other is concatenation:
  ```
string s = "CS" '4501'; // equals "CS4501"
```



## More general arrays
- We can create arrays of any type:
  ```
uint8[6] memory p = [ 1, 2, 3, 4, 5, 6 ];
```
  - We'll see the `memory` keyword shortly...



## Enums
- Enumerated type, which is mapped to a `uint`
```
enum ActionChoices { GoLeft, GoRight, 
                       GoStraight, SitStill }
//
ActionChoices choice;
ActionChoices constant default = ActionChoices.GoLeft;
//
function setGoStraight() public {
    choice = ActionChoices.GoStraight;
}
```



## Mappings
- An associative array (like a hash table) that holds a key-value pair
```
mapping (address => bool) public voters;
mapping (uint => Choice) public choices;
```
  - We'll talk about `public` visibility later
- To access a mapping value:
```
if ( voters[msg.sender] ) { ... }
```
- To write to a mapping:
```
voters[msg.sender] = true;
```



## Mappings of mappings
- You can have mappings to mappings:
```
mapping (uint => mapping(string => address) ) 
              public twodmap;
```
- It's just like a 2-dimensional array:
```
twodmap[3]["foo"]
```



## Mapping keys
- The keys are actually the *hash* of the key you provide
  - If you provide the character `1` as the key, the actual key is the Keccak256 hash of that
  - Or 0xc89efdaa54c0f20c7adf612882df0950f5a951637e0307cd cb4c672f298b8bc6
- In every mapping, *all* $2^{256}$ keys exist
  - Anything not explicitly set returns 0 / false / all zero's
  - So no point in getting a mapping's size!
- You can delete an element from a mapping:
  - `delete map[1];`
  - This really just sets the value to 0
  - And it *restores* gas (since it's shrinking the EVM state)



## Is an element in a mapping?
- Consider:
```
mapping (address => bool) public voters;
// this next one was not in the original Choices.sol:
mapping (address => uint) public how_voted;
//
// or:
//
mapping (uint => Choice) public choices;
uint public num_choices;
```
- The `voters` tells if an address has voted
  - If they haven't, then that key's value will be 0 (false)
  - The `how_voted` will tell what they voted for
- For the Choices, the uint tells how many keys there are



## Structs
- Like a class without methods
```
struct Choice {
    uint id;
    string name;
    uint votes;
}
```
  - Structs can contain mappings as well
- They are often kept in a mapping:
```
mapping (uint => Choice) public choices;
```
- If you put the same `Choice` struct into different mappings, you *might* now have *two* copies of that struct!



## Time
- All time is kept as a UNIX timestamp
  - The number of seconds since January 1st, 1970
  - This is how it's kept in the blockchain as well
- Only time available in a contract is the timestamp of the block
  - Via `block.timestamp`
- Can use `seconds`, `minutes`, `hours`, `days`, and `weeks` as time units
  - They are always pluralized
  - But the number before each must be a literal, not a variable!
  - Example on the next slide



## Time units example
```
uint a = 1;
uint b = 5;
uint c = 2;

// valid:
uint endTime = block.timestamp + 
               1 seconds + 5 minutes + 2 days;

// not valid:
uint endTime = block.timestamp +
               a seconds + b minutes + c days;

// valid:
uint endTime = block.timestamp + 
               a * 1 seconds + b * 1 minutes + c * 1 days;
```



## Ether units
- Can convert ether units as well
- All convert to wei (recall that 1 ether is $10^{18}$ wei)
```
assert(1 wei == 1);
assert(1 gwei == 1e9);
assert(1 ether == 1e18);
```




## Reference types
- Reference types are: strings, arrays, mappings, and structs
- Like Java and Python, the language often hides that it's a reference





## Memory locations
- All reference types must specify a memory location
  - `storage`: for all state variables, it is stored on the blockchain
    - statically allocated, like the stack on x86
    - two sub-types:
      - local storage (local subroutine variable)
      - state storage (state/class variable on the blockchain)
  - `memory`: a local variable, it only exists while the subroutine is executing
    - dynamically allocated, like the heap in x86
  - `calldata`: read-only, used for function parameters



## Assignments of references
- If you assign one reference type to another, what happens depends on where the data is stored:

| To (lhs) | From (rhs) | Result |
|--|--|--|
| memory | memory | reference aliasing |
| memory | any storage | full copy |
| memory | calldata | full copy |
| any storage | memory | full copy |
| any storage | calldata | full copy |
| local storage | any storage | reference aliasing |
| state storage | any storage | full copy |
| calldata | (any) | not allowed |



## Assignments of references
- How to remember:
  - You can't ever write to `calldata`
  - Anything assigned between *different* types of memory is always a copy, as references can't point from one memory type to another
  - State storage, which is on the blockchain, never stores references -- so anything copied to state storage is always a full copy
  - Reference aliasing works in the 2 cases when the memory types are the same and it's not going into state storage: memory to memory, and any storage to local storage



## String functions
- No (direct) built-in string comparison!
  - Reasons:
    - It is difficult / expensive to compare across memory locations
  - Instead, compare their hashes: 
    ```
if ( keccak256(x) == keccak256(y) ) { ... }
```
    - Note that `keccak256()` uses a lot of gas
- Can concatenate two strings:
  ```
string memory s = string.concat(s1, s2);
```
  - Only returns a `string memory`
- There are 3rd party string function libraries
  - Which contain comparisons, among other functions



<h2>Code Example</h2>

<pre class="code-wrapper"><code class="hljs d small" style="height:100%;">// SPDX-License-Identifier: GPL-3.0
pragma solidity >=0.5.0 <0.9.0;

contract C {
  // The data location of x is storage; this is the 
  // only place where the data location can be omitted
  uint[] x;

  // The data location of memoryArray is memory.
  function f(uint[] memory memoryArray) public {
    x = memoryArray; // works, copies the whole array to storage
    uint[] storage y = x; // works, assigns a pointer, y's location is storage
    y[7]; // fine, returns the 8th element
    y.pop(); // fine, modifies x through y
    delete x; // fine, clears the array, also modifies y
    // The following doesn't work; it would need to create a new temporary /
    // unnamed array in storage, but storage is "statically" allocated:
    // y = memoryArray;
    // This does not work either, since it would "reset" the pointer, 
    // but there is no sensible location it could point to.
    // delete y;
    g(x); // calls g, handing over a reference to x
    h(x); // calls h and creates an independent, temporary copy in memory
  }

  function g(uint[] storage) internal pure {}
  function h(uint[] memory) public pure {}
}
</code></pre>



## Even more...
- There are a lot of types we are skipping
- See them all in the [Solidity types reference](https://docs.soliditylang.org/en/latest/types.html)
  - https://docs.soliditylang.org/en/latest/types.html

</textarea></section>

  </section>

<!-- ============================================================ -->
  
  <section>

    <section id="concepts" data-markdown class="center"><textarea>
# Concepts
    </textarea></section>

    <section data-markdown data-separator="^\n\n\n"><textarea>
## Learning Solidity
- The easy part: learning the language
  - It's just an OO language with familiar syntax
- The hard part is understanding:
  - The restrictions that blockchain programs have
    - No time or random numbers
    - No print statements!
  - How to best interact with the blockchain
  - What the heck do you do with it?
- The easy part will be done in the next 20 minutes
- The hard part will be the rest of this course



## Sources
- The main reference is the [Solidity language documentation](https://docs.soliditylang.org/en/latest/index.html)
  - URL: https://docs.soliditylang.org/en/latest/index.html
- [Ethereum developer resources](https://ethereum.org/en/developers/)
  - URL: https://ethereum.org/en/developers/
- [Solidity reference](https://docs.soliditylang.org)
  - URL: https://docs.soliditylang.org
- [Remix documentation](https://remix-ide.readthedocs.io/en/latest/) (the Solidity IDE)
  - URL: https://remix-ide.readthedocs.io/en/latest/




## License identifier
- All Solidity smart contracts should have a license line as the first line
  - SPDX is the [Software Package Development Exchange](https://spdx.dev/)
- Examples:
```
// SPDX-License-Identifier: MIT
```
```
// SPDX-License-Identifier: CC BY-SA
```
```
// SPDX-License-Identifier: GPL
```
- A compiler will issue a warning if it's not there
- The actual license type is not checked, so you can also use:
```
// SPDX-License-Identifier: Unlicensed
```



## Pragma
- We'll only use the following Solidity version pragma:
```
pragma solidity ^0.8.7;
```
- The three numbers are: major version, minor version, bugfix version
- By default, it forces a compiler error if the wrong compiler version is being used
  - Some platforms, such as Truffle or Remix, will try to find the right compiler version
- This will only compile with version 0.8.7 or later
  - But will NOT allow compilation with version 0.9.0 or later
- Note that breaking changes (very few!) are only (intentionally) introduced on major versions



## Pragma
- More complicated examples are possible:

```
pragma solidity >=0.4.0 <0.6.0;
```

- One to avoid: note there is no carat before the version number
  - Reason: a later bugfix version, 0.8.12, will not compile this program

```
pragma solidity 0.8.11;
```

- In this course, we'll use ONLY the following:
  - As this will compile on all of the platforms we will be using

```
pragma solidity ^0.8.7;
```



## Comments
- C++ and Java style comments

```
// this is a comment

/* this is a
   multi-line
   comment
 */

/* this is a
 * multi-line
 * comment with better
 * formatting
 */
 ```



## Import
- Default import statement:
```
import "filename.sol";
```
  - Note that this will pollute the namespace
- We can also use:
```
import * as symbolName from "filename.sol";
```
  - All names from the file can be accessed via `symbolName.thing`
  - An equivalent version of this is:
```
import "filename.sol" as symbolName;
```
- Naming collision?  Then rename it upon import:
```
import {symbol1 as alias, symbol2} from "filename.sol";
```



## High-level "things"
- `contract`
  - Essentially an OO class
  - Can also be `abstract`
- `interface`
  - Just like interfaces in Java, or pure abstract classes in C++
- `library`
  - Can contain ONLY functions that do not access state
    - Meaning no contract field access
    - Specifically, they can only contain `pure` functions (we'll see `pure` shortly)



## Inheritance
- Contracts can inherit from interfaces and other contracts
  - Interfaces can inherit from (only) other interfaces
  - Via the `is` keyword
- The super-class (or super-interface) must be defined above or `import`'ed
```
contract Student is Person {
  // ...
}
```
```
interface Foo is Bar {
  // ...
}
```
- Any contract that inherits from an interface, but does not implement all the methods, must be declared `abstract`



## Inheritance
- `virtual`: if a *thing* (function, field, etc.) in a contract can be overridden
  - All function prototypes in interfaces are assumed to be `virtual`
- `override`: when a sub-class is replacing an inherited function
  - If the function is multiply inherited, you have to specify which (or all) that it overrides:
    - `function foo() public override(ERC721, IERC165) {`
    - This will be needed in the Tokens assignment
    </textarea></section>

    <section data-markdown data-separator="^\n\n\n" id='abscon'><textarea>
## Abstract Contracts
- A `contract` must have all the methods implemented
- An `interface` can have no methods implemented
- An `abstract contract` can have some methods implemented and some not
  - Part interface, part contract
  - Example: if you inherit from an interface, but only implement some of the methods
  - Example: if you inherit from a contract and a (different) interface

```
abstract contract Foo {
  // ...
}
```
    </textarea></section>

    <section data-markdown data-separator="^\n\n\n"><textarea>
## What we have so far
```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.7;

interface IERC165 {
  // ...
}

interface IERC721 is IERC165 {
  // ...
}

contract ERC721 is IERC721 {
  // ...
}

library Address {
  // ...
}
```



## Visibilities
- `public`: like any other OO language, it can be called by anybody or anyone
  - For fields, this is only the *readability* of the field; only contract functions can *write* to the field
- `private`: like any other OO language, it can be called only by code in that class
- `internal`: like `protected` in other OO languages: it can be called by that class or it's sub-classes
- `external`: like `public`, but can ONLY be called by code *outside* the contract; code in the contract can not call an `external` function
  - Functions in interfaces must be declared `external`
    </textarea></section>

    <section data-markdown data-separator="^\n\n\n" id="getters"><textarea>
## Visibilities
- The stated visibility in an interface can be expanded (only) in the contract
  - Example: if an interface specifies a function as `external`...
    - Then the implementing contract can specify it either as `external` or `public`
      - As `public` is *more* visible than `external`
- Anything field defined as `public` has a getter function defined for it -- see the next slide
  - If you have `uint public k`, then you can call the `k()` getter function to access its value
- The default, if unspecified, is `public`
  - But without a getter function
- Note that all data is still visible on the blockchain, even for `private` fields!
    </textarea></section>

    <section data-markdown data-separator="^\n\n\n"><textarea>
## Getter functions
- The following code:
```
uint public num_assignments;
mapping (address => string) public aliases;
mapping (uint => mapping(string => address) ) 
              public twodmap;
```
- Creates the following getter functions:
```
function num_assignments() public returns (uint);
function aliases(address a) public 
                  returns (string memory);
function twodmap(uint id, string s) public
                  returns (address);
```



## Function Qualifiers
- `view`: this function does not *modify* the state of the contract
  - It can read state variables, but not write to any state variables
  - It can write to local variables, of course
  - Like `const` in C++
- `pure`: this function does not *read or write* the state of the contract
  - Any function in a `library` must be `pure`
  - `view` and `pure` are mutually exclusive
- Using these qualifiers allows calls without having to make a transaction
  - And *may* allow optimizations which reduce contract size and gas costs



## Declarations for fields
- Format:
  ```
<type> <visibility?> <override?> <name> [= <value>];
```
- Examples:
```
uint public duration = 86400;
uint public override k;
uint l;
address public override initiator;
mapping (address => uint) internal override values;
```
- Local variables are similar
  - But without the visibility and `override` qualifiers



## Declarations for functions
- Format:
```
function <name> ([<parameter_list>]) <visibility?> 
                <qualifiers> [returns (<list>)] {
```
- Examples:
```
function addChoice (string memory _name) public {
//
function unnecessaryFunction() public view 
                returns (string memory) {
//
function overridePureFunction() external pure 
                override returns (uint,bool) {
```



## Require and revert
- A reversion means the transaction method fails, and all state is rolled back to before it started
  - Still costs gas fees!
- `revert()` will do this
- Also:
  - `require(a>0);` will revert if $a$ is not greater than zero
  - Better to use the two-parameter version:
  - `require(a>0,"a must be greater than zero");`
    - Now, if/when it reverts, it will tell you why
  - Use this liberally!!!



## Receiving ether
- The `payable` qualifier means the function can accept ether as part of the call
- The amount of ether received is in `msg.value`
  - And is added to the contract's balance
    - ... assuming it doesn't revert



## Constructors
- Syntax:
```
constructor() {
    // ...
}
```
- No `function` keyword, no return type
- Default, if not specified, is an empty body
- Can take parameters:
```
constructor(uint foo) {
    // ...
}
```



## Destructor
- `selfdesctruct()`
  - Only if enabled
  - Caller claims the ether balance



## Contract elements
- A contract can have:
  - Fields
  - Functions
  - A constructor and a `selfdestruct()` method
  - A few other special-purpose methods we won't see here
  - Modifiers



## Modifiers
- A modifier changes how a function works
- You put in conditions (or whatever) and then indicate where the function body goes
- That indication is with the underscore
  ```
    modifier onlyOwner() {
        require(msg.sender == owner, "Not owner");
        _;
    }
```



## Modifiers
- This code adapted from [here](https://solidity-by-example.org/function-modifier/)

<pre class="code-wrapper"><code class="hljs d small" style="height:100%;"
>contract Modifiers {
    address public owner;

    constructor() {
        owner = msg.sender;
    }

    modifier onlyOwner() {
        require(msg.sender == owner, "Not owner");
        _;
    }

    modifier validAddress(address _addr) {
        require(_addr != address(0), "Not valid address");
        _;
    }

    function changeOwner(address _newOwner) public onlyOwner 
                                            validAddress(_newOwner) {
        owner = _newOwner;
    }
}
</code></pre>



## Events & emit
- An *event* is when something happens
- Allows for logging of what has happened to a contract
- They are declared in contracts or interfaces:
```
event votedEvent (uint indexed _id);
event choiceAddedEvent (uint indexed _id);
```
  - The `indexed` keyword allows for searching the event log by that value
- Events are called via `emit`:
```
emit choiceAddedEvent(num_choices);
emit votedEvent(_id);
```
- Events can be "watched" for (or "subscribed to")
  - We'll see this later this semester



## Try-catch
- Try-catch:

```
try something {
  // what to do if it succeeds
} catch {
  // what to do if it fails
}

```
- The "something" can be:
  - Calling a function
  - Creating a new contract
  - Or anything else
- If the something reverts, the catch clause is executed
</textarea></section>

    <section data-markdown data-separator="^\n\n\n" id='payeth'><textarea>
## Transferring ether in Solidity
- To transfer ether from a Solidity contract:
  ```
  (bool success, ) = payable(a).call{value: v}("");
  require(success, "Failed to transfer ETH");
  ```
- The amount, in `v`, is in wei
- The address to pay it to is in `a`
- This reverts if the contract does not have sufficient balance
</textarea></section>

    <section data-markdown data-separator="^\n\n\n"><textarea>
## Contracts creating contracts
- We can have a contract `Foo` deploy another contract `Bar`
- Given a field in Foo such as either:
  ```
  Bar public b;
  address public b;
  ```
- Then we can initialize it via either (respectively):
  ```
  b = new Bar();
  b = address(new Bar());
  ```



## Most useful global variables
From [here](https://docs.soliditylang.org/en/v0.8.12/units-and-global-variables.html)

- block.timestamp (uint)
  - current block timestamp as seconds since unix epoch
- block.difficulty (uint)
  - current block difficulty
- msg.sender (address)
  - sender of the message (current call)
- msg.value (uint)
  - number of wei sent with the message
- this
  - the current contract (example: address(this).balance)



## Other global variables
- block.basefee (uint): current block's base fee (EIP-3198 and EIP-1559)
- block.chainid (uint): current chain id
- block.coinbase (address payable): current block miner's address
- block.gaslimit (uint): current block gaslimit
- block.number (uint): current block number
- gasleft() returns (uint256): remaining gas
- msg.data (bytes calldata): complete calldata
- msg.sig (bytes4): first four bytes of the calldata (i.e. function identifier)
- tx.gasprice (uint): gas price of the transaction
- tx.origin (address): sender of the transaction (full call chain)



## Global functions
- blockhash(uint blockNumber) returns (bytes32)
  - hash of the given block when blocknumber is one of the 256 most recent blocks; otherwise returns zero
- keccak256(bytes memory) returns (bytes32)



## Solidity cheat sheet
- See the one at https://docs.soliditylang.org/en/latest/cheatsheet.html
- In PDF form in the repo as [doc/solidity_cheatsheet.pdf](../doc/solidity_cheatsheet.pdf)



## Solidity bytecode
Consider the following Solidity smart contract:
```
pragma solidity ^0.8.7;
contract MyContract {
    uint i = 1 + 2 * 3 - 4;
}
```
To see the bytecode:
- Got to [remix.ethereum.org](http://remix.ethereum.org), create a new contract file, and enter the text
- Select the compiler icon on the left, and click 'compile'
- Select 'compilation details', the 'Assembly' at the bottom



## Solidity bytecode
<pre class="code-wrapper"><code class="hljs d small" style="height:100%;"
>.code
  PUSH 80         contract MyContract {\n    uin...
  PUSH 40         contract MyContract {\n    uin...
  MSTORE          contract MyContract {\n    uin...
  PUSH 3          1 + 2 * 3 - 4
  PUSH 0          uint i = 1 + 2 * 3 - 4
  SSTORE          uint i = 1 + 2 * 3 - 4
  CALLVALUE       contract MyContract {\n    uin...
  DUP1            contract MyContract {\n    uin...
  ISZERO          contract MyContract {\n    uin...
  PUSH [tag] 1    contract MyContract {\n    uin...
  JUMPI           contract MyContract {\n    uin...
  PUSH 0          contract MyContract {\n    uin...
  DUP1            contract MyContract {\n    uin...
  REVERT          contract MyContract {\n    uin...
tag 1             contract MyContract {\n    uin...
  JUMPDEST        contract MyContract {\n    uin...
  POP             contract MyContract {\n    uin...
  PUSH #[$] 0000000000000000000000000000000000000000000000000000000000000000
                  // contract MyContract {\n    uin...
  DUP1            contract MyContract {\n    uin...
  PUSH [$]  0000000000000000000000000000000000000000000000000000000000000000
                  // contract MyContract {\n    uin...
  PUSH 0          contract MyContract {\n    uin...
  CODECOPY        contract MyContract {\n    uin...
  PUSH 0          contract MyContract {\n    uin...
  RETURN          contract MyContract {\n    uin...
.data
  0:
    .code
      PUSH 80     contract MyContract {\n    uin...
      PUSH 40     contract MyContract {\n    uin...
      MSTORE      contract MyContract {\n    uin...
      PUSH 0      contract MyContract {\n    uin...
      DUP1        contract MyContract {\n    uin...
      REVERT      contract MyContract {\n    uin...
    .data
</code></pre>



## Solidity hex bytecode
- That bytecode is compiled into hex (binary):
```
60806040526003600055348015601457600080fd5b50603f80
60226000396000f3fe6080604052600080fdfea26469706673
58221220332ec7c6c4346f275b4aa81ab96bdd2f2ef3f03aa7
90bcd131b849930bbaba9964736f6c634300080c0033
```
- This hex code will show up in the blockchain Ethereum explorer
  - In the "input" field
</textarea></section>

  </section>

<!-- ============================================================ -->
  
  <section>

    <section id="choices" data-markdown class="center"><textarea>
# Choices Example
    </textarea></section>

    <section data-markdown data-separator="^\n\n\n"><textarea>
## Choices Example
- This is the [Choices.sol](../hws/dappintro/Choices.sol.html) smart contract from the the [dApp Introduction](../hws/dappintro/index.html) assignment
  - Shown in full on the next slide



<pre class="code-wrapper"><code class="hljs awk small" style="height:auto">//SPDX-License-Identifier: CC BY-SA

pragma solidity ^0.8.7;

contract Choices {

  struct Choice {
    uint id;
    string name;
    uint votes;
  }

  mapping (address => bool) public voters;
  mapping (uint => Choice) public choices;

  uint public num_choices;

  event votedEvent (uint indexed _id);
  event choiceAddedEvent (uint indexed _id);

  constructor() {
    addChoice("red");
    addChoice("orange");
    addChoice("yellow");
    addChoice("green");
    addChoice("blue");
    addChoice("purple");
  }

  function addChoice (string memory _name) public {
    choices[num_choices] = Choice(num_choices, _name, 0);
    emit choiceAddedEvent(num_choices);
    num_choices++;
  }

  function vote (uint _id) public {
    require(!voters[msg.sender], "sender has already voted");
    require(_id >= 0 && _id < num_choices, "invalid vote selection");
    voters[msg.sender] = true;
    choices[_id].votes++;
    emit votedEvent(_id);
  }

  function unnecessaryFunction() public view returns (string memory) {
    return choices[0].name;
  }

}

</code></pre>



## Choices ABI

<pre class="code-wrapper" style="height:550px"><code class="hljs awk small">[
  {
    "inputs": [],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "_id",
        "type": "uint256"
      }
    ],
    "name": "choiceAddedEvent",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "_id",
        "type": "uint256"
      }
    ],
    "name": "votedEvent",
    "type": "event"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_name",
        "type": "string"
      }
    ],
    "name": "addChoice",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "choices",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "id",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "name",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "votes",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "num_choices",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "unnecessaryFunction",
    "outputs": [
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_id",
        "type": "uint256"
      }
    ],
    "name": "vote",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "voters",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  }
]
</code></pre>



## Compiled bytecode
<pre class="code-wrapper" style="height:500px"><code class="hljs awk small"
>60806040523480156200001157600080fd5b5062000058604051806040016040528060038152
6020017f72656400000000000000000000000000000000000000000000000000000000008152
50620001bc60201b60201c565b6200009e6040518060400160405280600681526020017f6f72
616e67650000000000000000000000000000000000000000000000000000815250620001bc60
201b60201c565b620000e46040518060400160405280600681526020017f79656c6c6f770000
000000000000000000000000000000000000000000000000815250620001bc60201b60201c56
5b6200012a6040518060400160405280600581526020017f677265656e000000000000000000
000000000000000000000000000000000000815250620001bc60201b60201c565b6200017060
40518060400160405280600481526020017f626c756500000000000000000000000000000000
000000000000000000000000815250620001bc60201b60201c565b620001b660405180604001
60405280600681526020017f707572706c650000000000000000000000000000000000000000
000000000000815250620001bc60201b60201c565b6200040d565b6040518060600160405280
6002548152602001828152602001600081525060016000600254815260200190815260200160
0020600082015181600001556020820151816001019080519060200190620002179291906200
0271565b50604082015181600201559050506002547f8c289382d6fd42a02a06e885da5a69cb
0f21294bbfc7acc91d5cf3ced61ca0c460405160405180910390a26002600081548092919062
0002699062000361565b919050555050565b8280546200027f906200032b565b906000526020
60002090601f016020900481019282620002a35760008555620002ef565b82601f10620002be
57805160ff1916838001178555620002ef565b82800160010185558215620002ef579182015b
82811115620002ee578251825591602001919060010190620002d1565b5b509050620002fe91
9062000302565b5090565b5b808211156200031d57600081600090555060010162000303565b
5090565b6000819050919050565b600060028204905060018216806200034457607f82169150
5b602082108114156200035b576200035a620003de565b5b50919050565b60006200036e8262
000321565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffff821415620003a457620003a3620003af565b5b600182019050919050565b7f4e487b7100
0000000000000000000000000000000000000000000000000000006000526011600452602460
00fd5b7f4e487b71000000000000000000000000000000000000000000000000000000006000
52602260045260246000fd5b610b5f806200041d6000396000f3fe6080604052348015610010
57600080fd5b50600436106100625760003560e01c80630121b93f14610067578063251760b7
146100835780635fa520bb146100a1578063a3ec138d146100bd578063dc899a07146100ed57
8063f6fd7fde1461010b575b600080fd5b610081600480360381019061007c91906106af565b
61013d565b005b61008b6102cd565b60405161009891906107f6565b60405180910390f35b61
00bb60048036038101906100b69190610666565b6102d3565b005b6100d76004803603810190
6100d29190610639565b610384565b6040516100e49190610779565b60405180910390f35b61
00f56103a4565b6040516101029190610794565b60405180910390f35b610125600480360381
019061012091906106af565b61044a565b60405161013493929190610811565b604051809103
90f35b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffff
ffffffffffffffffffffffff16815260200190815260200160002060009054906101000a9004
60ff16156101c9576040517f08c379a000000000000000000000000000000000000000000000
00000000000081526004016101c0906107b6565b60405180910390fd5b600081101580156101
db575060025481105b61021a576040517f08c379a00000000000000000000000000000000000
00000000000000000000008152600401610211906107d6565b60405180910390fd5b60016000
803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffff
ffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083
1515021790555060016000828152602001908152602001600020600201600081548092919061
0298906109ae565b9190505550807ffff3c900d938d21d0990d786e819f29b8d05c1ef587b46
2b939609625b684b1660405160405180910390a250565b60025481565b604051806060016040
5280600254815260200182815260200160008152506001600060025481526020019081526020
0160002060008201518160000155602082015181600101908051906020019061032c92919061
04fc565b50604082015181600201559050506002547f8c289382d6fd42a02a06e885da5a69cb
0f21294bbfc7acc91d5cf3ced61ca0c460405160405180910390a26002600081548092919061
037c906109ae565b919050555050565b60006020528060005260406000206000915054906101
000a900460ff1681565b60606001600080815260200190815260200160002060010180546103
c79061094b565b80601f01602080910402602001604051908101604052809291908181526020
018280546103f39061094b565b80156104405780601f10610415576101008083540402835291
60200191610440565b820191906000526020600020905b815481529060010190602001808311
61042357829003601f168201915b5050505050905090565b6001602052806000526040600020
6000915090508060000154908060010180546104739061094b565b80601f0160208091040260
20016040519081016040528092919081815260200182805461049f9061094b565b80156104ec
5780601f106104c1576101008083540402835291602001916104ec565b820191906000526020
600020905b8154815290600101906020018083116104cf57829003601f168201915b50505050
50908060020154905083565b8280546105089061094b565b90600052602060002090601f0160
2090048101928261052a5760008555610571565b82601f1061054357805160ff191683800117
8555610571565b82800160010185558215610571579182015b82811115610570578251825591
602001919060010190610555565b5b50905061057e9190610582565b5090565b5b8082111561
059b576000816000905550600101610583565b5090565b60006105b26105ad84610874565b61
084f565b9050828152602081018484840111156105ce576105cd610a89565b5b6105d9848285
610909565b509392505050565b6000813590506105f081610afb565b92915050565b60008260
1f83011261060b5761060a610a84565b5b813561061b84826020860161059f565b9150509291
5050565b60008135905061063381610b12565b92915050565b60006020828403121561064f57
61064e610a93565b5b600061065d848285016105e1565b91505092915050565b600060208284
03121561067c5761067b610a93565b5b600082013567ffffffffffffffff81111561069a5761
0699610a8e565b5b6106a6848285016105f6565b91505092915050565b600060208284031215
6106c5576106c4610a93565b5b60006106d384828501610624565b91505092915050565b6106
e5816108d3565b82525050565b60006106f6826108a5565b61070081856108b0565b93506107
10818560208601610918565b61071981610a98565b840191505092915050565b600061073160
18836108b0565b915061073c82610aa9565b602082019050919050565b600061075460168361
08b0565b915061075f82610ad2565b602082019050919050565b610773816108ff565b825250
50565b600060208201905061078e60008301846106dc565b92915050565b6000602082019050
81810360008301526107ae81846106eb565b905092915050565b600060208201905081810360
008301526107cf81610724565b9050919050565b600060208201905081810360008301526107
ef81610747565b9050919050565b600060208201905061080b600083018461076a565b929150
50565b6000606082019050610826600083018661076a565b8181036020830152610838818561
06eb565b9050610847604083018461076a565b949350505050565b600061085961086a565b90
50610865828261097d565b919050565b6000604051905090565b600067ffffffffffffffff82
111561088f5761088e610a55565b5b61089882610a98565b9050602081019050919050565b60
0081519050919050565b600082825260208201905092915050565b60006108cc826108df565b
9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffff
ffffffff82169050919050565b6000819050919050565b82818337600083830152505050565b
60005b8381101561093657808201518184015260208101905061091b565b8381111561094557
6000848401525b50505050565b6000600282049050600182168061096357607f821691505b60
20821081141561097757610976610a26565b5b50919050565b61098682610a98565b81018181
1067ffffffffffffffff821117156109a5576109a4610a55565b5b80604052505050565b6000
6109b9826108ff565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffff8214156109ec576109eb6109f7565b5b600182019050919050565b7f4e487b71
0000000000000000000000000000000000000000000000000000000060005260116004526024
6000fd5b7f4e487b710000000000000000000000000000000000000000000000000000000060
0052602260045260246000fd5b7f4e487b710000000000000000000000000000000000000000
0000000000000000600052604160045260246000fd5b600080fd5b600080fd5b600080fd5b60
0080fd5b6000601f19601f8301169050919050565b7f73656e6465722068617320616c726561
647920766f7465640000000000000000600082015250565b7f696e76616c696420766f746520
73656c656374696f6e00000000000000000000600082015250565b610b04816108c1565b8114
610b0f57600080fd5b50565b610b1b816108ff565b8114610b2657600080fd5b5056fea26469
70667358221220a50d8908e80f557ec91730863500e2c51daaa1a7b297adc495dcb50976b506
1a64736f6c63430008070033
</code></pre>

Got all that?  See it on the blockchain explorer as well.



## Bytecode Opcodes
<pre class="code-wrapper" style="height:550px"><code class="hljs awk small"
>PUSH1 0x80 PUSH1 0x40 MSTORE CALLVALUE DUP1 ISZERO PUSH3 0x11 JUMPI PUSH1 0x0
DUP1 REVERT JUMPDEST POP PUSH3 0x58 PUSH1 0x40 MLOAD DUP1 PUSH1 0x40 ADD
PUSH1 0x40 MSTORE DUP1 PUSH1 0x3 DUP2 MSTORE PUSH1 0x20 ADD PUSH32
0x7265640000000000000000000000000000000000000000000000000000000000 DUP2
MSTORE POP PUSH3 0x1BC PUSH1 0x20 SHL PUSH1 0x20 SHR JUMP JUMPDEST PUSH3 0x9E
PUSH1 0x40 MLOAD DUP1 PUSH1 0x40 ADD PUSH1 0x40 MSTORE DUP1 PUSH1 0x6 DUP2
MSTORE PUSH1 0x20 ADD PUSH32
0x6F72616E67650000000000000000000000000000000000000000000000000000 DUP2
MSTORE POP PUSH3 0x1BC PUSH1 0x20 SHL PUSH1 0x20 SHR JUMP JUMPDEST PUSH3 0xE4
PUSH1 0x40 MLOAD DUP1 PUSH1 0x40 ADD PUSH1 0x40 MSTORE DUP1 PUSH1 0x6 DUP2
MSTORE PUSH1 0x20 ADD PUSH32
0x79656C6C6F770000000000000000000000000000000000000000000000000000 DUP2
MSTORE POP PUSH3 0x1BC PUSH1 0x20 SHL PUSH1 0x20 SHR JUMP JUMPDEST PUSH3
0x12A PUSH1 0x40 MLOAD DUP1 PUSH1 0x40 ADD PUSH1 0x40 MSTORE DUP1 PUSH1 0x5
DUP2 MSTORE PUSH1 0x20 ADD PUSH32
0x677265656E000000000000000000000000000000000000000000000000000000 DUP2
MSTORE POP PUSH3 0x1BC PUSH1 0x20 SHL PUSH1 0x20 SHR JUMP JUMPDEST PUSH3
0x170 PUSH1 0x40 MLOAD DUP1 PUSH1 0x40 ADD PUSH1 0x40 MSTORE DUP1 PUSH1 0x4
DUP2 MSTORE PUSH1 0x20 ADD PUSH32
0x626C756500000000000000000000000000000000000000000000000000000000 DUP2
MSTORE POP PUSH3 0x1BC PUSH1 0x20 SHL PUSH1 0x20 SHR JUMP JUMPDEST PUSH3
0x1B6 PUSH1 0x40 MLOAD DUP1 PUSH1 0x40 ADD PUSH1 0x40 MSTORE DUP1 PUSH1 0x6
DUP2 MSTORE PUSH1 0x20 ADD PUSH32
0x707572706C650000000000000000000000000000000000000000000000000000 DUP2
MSTORE POP PUSH3 0x1BC PUSH1 0x20 SHL PUSH1 0x20 SHR JUMP JUMPDEST PUSH3
0x40D JUMP JUMPDEST PUSH1 0x40 MLOAD DUP1 PUSH1 0x60 ADD PUSH1 0x40 MSTORE
DUP1 PUSH1 0x2 SLOAD DUP2 MSTORE PUSH1 0x20 ADD DUP3 DUP2 MSTORE PUSH1 0x20
ADD PUSH1 0x0 DUP2 MSTORE POP PUSH1 0x1 PUSH1 0x0 PUSH1 0x2 SLOAD DUP2 MSTORE
PUSH1 0x20 ADD SWAP1 DUP2 MSTORE PUSH1 0x20 ADD PUSH1 0x0 KECCAK256 PUSH1 0x0
DUP3 ADD MLOAD DUP2 PUSH1 0x0 ADD SSTORE PUSH1 0x20 DUP3 ADD MLOAD DUP2 PUSH1
0x1 ADD SWAP1 DUP1 MLOAD SWAP1 PUSH1 0x20 ADD SWAP1 PUSH3 0x217 SWAP3 SWAP2
SWAP1 PUSH3 0x271 JUMP JUMPDEST POP PUSH1 0x40 DUP3 ADD MLOAD DUP2 PUSH1 0x2
ADD SSTORE SWAP1 POP POP PUSH1 0x2 SLOAD PUSH32
0x8C289382D6FD42A02A06E885DA5A69CB0F21294BBFC7ACC91D5CF3CED61CA0C4 PUSH1 0x40
MLOAD PUSH1 0x40 MLOAD DUP1 SWAP2 SUB SWAP1 LOG2 PUSH1 0x2 PUSH1 0x0 DUP2
SLOAD DUP1 SWAP3 SWAP2 SWAP1 PUSH3 0x269 SWAP1 PUSH3 0x361 JUMP JUMPDEST
SWAP2 SWAP1 POP SSTORE POP POP JUMP JUMPDEST DUP3 DUP1 SLOAD PUSH3 0x27F
SWAP1 PUSH3 0x32B JUMP JUMPDEST SWAP1 PUSH1 0x0 MSTORE PUSH1 0x20 PUSH1 0x0
KECCAK256 SWAP1 PUSH1 0x1F ADD PUSH1 0x20 SWAP1 DIV DUP2 ADD SWAP3 DUP3 PUSH3
0x2A3 JUMPI PUSH1 0x0 DUP6 SSTORE PUSH3 0x2EF JUMP JUMPDEST DUP3 PUSH1 0x1F
LT PUSH3 0x2BE JUMPI DUP1 MLOAD PUSH1 0xFF NOT AND DUP4 DUP1 ADD OR DUP6
SSTORE PUSH3 0x2EF JUMP JUMPDEST DUP3 DUP1 ADD PUSH1 0x1 ADD DUP6 SSTORE DUP3
ISZERO PUSH3 0x2EF JUMPI SWAP2 DUP3 ADD JUMPDEST DUP3 DUP2 GT ISZERO PUSH3
0x2EE JUMPI DUP3 MLOAD DUP3 SSTORE SWAP2 PUSH1 0x20 ADD SWAP2 SWAP1 PUSH1 0x1
ADD SWAP1 PUSH3 0x2D1 JUMP JUMPDEST JUMPDEST POP SWAP1 POP PUSH3 0x2FE SWAP2
SWAP1 PUSH3 0x302 JUMP JUMPDEST POP SWAP1 JUMP JUMPDEST JUMPDEST DUP1 DUP3 GT
ISZERO PUSH3 0x31D JUMPI PUSH1 0x0 DUP2 PUSH1 0x0 SWAP1 SSTORE POP PUSH1 0x1
ADD PUSH3 0x303 JUMP JUMPDEST POP SWAP1 JUMP JUMPDEST PUSH1 0x0 DUP2 SWAP1
POP SWAP2 SWAP1 POP JUMP JUMPDEST PUSH1 0x0 PUSH1 0x2 DUP3 DIV SWAP1 POP
PUSH1 0x1 DUP3 AND DUP1 PUSH3 0x344 JUMPI PUSH1 0x7F DUP3 AND SWAP2 POP
JUMPDEST PUSH1 0x20 DUP3 LT DUP2 EQ ISZERO PUSH3 0x35B JUMPI PUSH3 0x35A
PUSH3 0x3DE JUMP JUMPDEST JUMPDEST POP SWAP2 SWAP1 POP JUMP JUMPDEST PUSH1
0x0 PUSH3 0x36E DUP3 PUSH3 0x321 JUMP JUMPDEST SWAP2 POP PUSH32
0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF DUP3 EQ
ISZERO PUSH3 0x3A4 JUMPI PUSH3 0x3A3 PUSH3 0x3AF JUMP JUMPDEST JUMPDEST PUSH1
0x1 DUP3 ADD SWAP1 POP SWAP2 SWAP1 POP JUMP JUMPDEST PUSH32
0x4E487B7100000000000000000000000000000000000000000000000000000000 PUSH1 0x0
MSTORE PUSH1 0x11 PUSH1 0x4 MSTORE PUSH1 0x24 PUSH1 0x0 REVERT JUMPDEST
PUSH32 0x4E487B7100000000000000000000000000000000000000000000000000000000
PUSH1 0x0 MSTORE PUSH1 0x22 PUSH1 0x4 MSTORE PUSH1 0x24 PUSH1 0x0 REVERT
JUMPDEST PUSH2 0xB5F DUP1 PUSH3 0x41D PUSH1 0x0 CODECOPY PUSH1 0x0 RETURN
INVALID PUSH1 0x80 PUSH1 0x40 MSTORE CALLVALUE DUP1 ISZERO PUSH2 0x10 JUMPI
PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH1 0x4 CALLDATASIZE LT PUSH2 0x62 JUMPI
PUSH1 0x0 CALLDATALOAD PUSH1 0xE0 SHR DUP1 PUSH4 0x121B93F EQ PUSH2 0x67
JUMPI DUP1 PUSH4 0x251760B7 EQ PUSH2 0x83 JUMPI DUP1 PUSH4 0x5FA520BB EQ
PUSH2 0xA1 JUMPI DUP1 PUSH4 0xA3EC138D EQ PUSH2 0xBD JUMPI DUP1 PUSH4
0xDC899A07 EQ PUSH2 0xED JUMPI DUP1 PUSH4 0xF6FD7FDE EQ PUSH2 0x10B JUMPI
JUMPDEST PUSH1 0x0 DUP1 REVERT JUMPDEST PUSH2 0x81 PUSH1 0x4 DUP1
CALLDATASIZE SUB DUP2 ADD SWAP1 PUSH2 0x7C SWAP2 SWAP1 PUSH2 0x6AF JUMP
JUMPDEST PUSH2 0x13D JUMP JUMPDEST STOP JUMPDEST PUSH2 0x8B PUSH2 0x2CD JUMP
JUMPDEST PUSH1 0x40 MLOAD PUSH2 0x98 SWAP2 SWAP1 PUSH2 0x7F6 JUMP JUMPDEST
PUSH1 0x40 MLOAD DUP1 SWAP2 SUB SWAP1 RETURN JUMPDEST PUSH2 0xBB PUSH1 0x4
DUP1 CALLDATASIZE SUB DUP2 ADD SWAP1 PUSH2 0xB6 SWAP2 SWAP1 PUSH2 0x666 JUMP
JUMPDEST PUSH2 0x2D3 JUMP JUMPDEST STOP JUMPDEST PUSH2 0xD7 PUSH1 0x4 DUP1
CALLDATASIZE SUB DUP2 ADD SWAP1 PUSH2 0xD2 SWAP2 SWAP1 PUSH2 0x639 JUMP
JUMPDEST PUSH2 0x384 JUMP JUMPDEST PUSH1 0x40 MLOAD PUSH2 0xE4 SWAP2 SWAP1
PUSH2 0x779 JUMP JUMPDEST PUSH1 0x40 MLOAD DUP1 SWAP2 SUB SWAP1 RETURN
JUMPDEST PUSH2 0xF5 PUSH2 0x3A4 JUMP JUMPDEST PUSH1 0x40 MLOAD PUSH2 0x102
SWAP2 SWAP1 PUSH2 0x794 JUMP JUMPDEST PUSH1 0x40 MLOAD DUP1 SWAP2 SUB SWAP1
RETURN JUMPDEST PUSH2 0x125 PUSH1 0x4 DUP1 CALLDATASIZE SUB DUP2 ADD SWAP1
PUSH2 0x120 SWAP2 SWAP1 PUSH2 0x6AF JUMP JUMPDEST PUSH2 0x44A JUMP JUMPDEST
PUSH1 0x40 MLOAD PUSH2 0x134 SWAP4 SWAP3 SWAP2 SWAP1 PUSH2 0x811 JUMP
JUMPDEST PUSH1 0x40 MLOAD DUP1 SWAP2 SUB SWAP1 RETURN JUMPDEST PUSH1 0x0 DUP1
CALLER PUSH20 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF AND PUSH20
0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF AND DUP2 MSTORE PUSH1 0x20 ADD
SWAP1 DUP2 MSTORE PUSH1 0x20 ADD PUSH1 0x0 KECCAK256 PUSH1 0x0 SWAP1 SLOAD
SWAP1 PUSH2 0x100 EXP SWAP1 DIV PUSH1 0xFF AND ISZERO PUSH2 0x1C9 JUMPI PUSH1
0x40 MLOAD PUSH32
0x8C379A000000000000000000000000000000000000000000000000000000000 DUP2 MSTORE
PUSH1 0x4 ADD PUSH2 0x1C0 SWAP1 PUSH2 0x7B6 JUMP JUMPDEST PUSH1 0x40 MLOAD
DUP1 SWAP2 SUB SWAP1 REVERT JUMPDEST PUSH1 0x0 DUP2 LT ISZERO DUP1 ISZERO
PUSH2 0x1DB JUMPI POP PUSH1 0x2 SLOAD DUP2 LT JUMPDEST PUSH2 0x21A JUMPI
PUSH1 0x40 MLOAD PUSH32
0x8C379A000000000000000000000000000000000000000000000000000000000 DUP2 MSTORE
PUSH1 0x4 ADD PUSH2 0x211 SWAP1 PUSH2 0x7D6 JUMP JUMPDEST PUSH1 0x40 MLOAD
DUP1 SWAP2 SUB SWAP1 REVERT JUMPDEST PUSH1 0x1 PUSH1 0x0 DUP1 CALLER PUSH20
0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF AND PUSH20
0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF AND DUP2 MSTORE PUSH1 0x20 ADD
SWAP1 DUP2 MSTORE PUSH1 0x20 ADD PUSH1 0x0 KECCAK256 PUSH1 0x0 PUSH2 0x100
EXP DUP2 SLOAD DUP2 PUSH1 0xFF MUL NOT AND SWAP1 DUP4 ISZERO ISZERO MUL OR
SWAP1 SSTORE POP PUSH1 0x1 PUSH1 0x0 DUP3 DUP2 MSTORE PUSH1 0x20 ADD SWAP1
DUP2 MSTORE PUSH1 0x20 ADD PUSH1 0x0 KECCAK256 PUSH1 0x2 ADD PUSH1 0x0 DUP2
SLOAD DUP1 SWAP3 SWAP2 SWAP1 PUSH2 0x298 SWAP1 PUSH2 0x9AE JUMP JUMPDEST
SWAP2 SWAP1 POP SSTORE POP DUP1 PUSH32
0xFFF3C900D938D21D0990D786E819F29B8D05C1EF587B462B939609625B684B16 PUSH1 0x40
MLOAD PUSH1 0x40 MLOAD DUP1 SWAP2 SUB SWAP1 LOG2 POP JUMP JUMPDEST PUSH1 0x2
SLOAD DUP2 JUMP JUMPDEST PUSH1 0x40 MLOAD DUP1 PUSH1 0x60 ADD PUSH1 0x40
MSTORE DUP1 PUSH1 0x2 SLOAD DUP2 MSTORE PUSH1 0x20 ADD DUP3 DUP2 MSTORE PUSH1
0x20 ADD PUSH1 0x0 DUP2 MSTORE POP PUSH1 0x1 PUSH1 0x0 PUSH1 0x2 SLOAD DUP2
MSTORE PUSH1 0x20 ADD SWAP1 DUP2 MSTORE PUSH1 0x20 ADD PUSH1 0x0 KECCAK256
PUSH1 0x0 DUP3 ADD MLOAD DUP2 PUSH1 0x0 ADD SSTORE PUSH1 0x20 DUP3 ADD MLOAD
DUP2 PUSH1 0x1 ADD SWAP1 DUP1 MLOAD SWAP1 PUSH1 0x20 ADD SWAP1 PUSH2 0x32C
SWAP3 SWAP2 SWAP1 PUSH2 0x4FC JUMP JUMPDEST POP PUSH1 0x40 DUP3 ADD MLOAD
DUP2 PUSH1 0x2 ADD SSTORE SWAP1 POP POP PUSH1 0x2 SLOAD PUSH32
0x8C289382D6FD42A02A06E885DA5A69CB0F21294BBFC7ACC91D5CF3CED61CA0C4 PUSH1 0x40
MLOAD PUSH1 0x40 MLOAD DUP1 SWAP2 SUB SWAP1 LOG2 PUSH1 0x2 PUSH1 0x0 DUP2
SLOAD DUP1 SWAP3 SWAP2 SWAP1 PUSH2 0x37C SWAP1 PUSH2 0x9AE JUMP JUMPDEST
SWAP2 SWAP1 POP SSTORE POP POP JUMP JUMPDEST PUSH1 0x0 PUSH1 0x20 MSTORE DUP1
PUSH1 0x0 MSTORE PUSH1 0x40 PUSH1 0x0 KECCAK256 PUSH1 0x0 SWAP2 POP SLOAD
SWAP1 PUSH2 0x100 EXP SWAP1 DIV PUSH1 0xFF AND DUP2 JUMP JUMPDEST PUSH1 0x60
PUSH1 0x1 PUSH1 0x0 DUP1 DUP2 MSTORE PUSH1 0x20 ADD SWAP1 DUP2 MSTORE PUSH1
0x20 ADD PUSH1 0x0 KECCAK256 PUSH1 0x1 ADD DUP1 SLOAD PUSH2 0x3C7 SWAP1 PUSH2
0x94B JUMP JUMPDEST DUP1 PUSH1 0x1F ADD PUSH1 0x20 DUP1 SWAP2 DIV MUL PUSH1
0x20 ADD PUSH1 0x40 MLOAD SWAP1 DUP2 ADD PUSH1 0x40 MSTORE DUP1 SWAP3 SWAP2
SWAP1 DUP2 DUP2 MSTORE PUSH1 0x20 ADD DUP3 DUP1 SLOAD PUSH2 0x3F3 SWAP1 PUSH2
0x94B JUMP JUMPDEST DUP1 ISZERO PUSH2 0x440 JUMPI DUP1 PUSH1 0x1F LT PUSH2
0x415 JUMPI PUSH2 0x100 DUP1 DUP4 SLOAD DIV MUL DUP4 MSTORE SWAP2 PUSH1 0x20
ADD SWAP2 PUSH2 0x440 JUMP JUMPDEST DUP3 ADD SWAP2 SWAP1 PUSH1 0x0 MSTORE
PUSH1 0x20 PUSH1 0x0 KECCAK256 SWAP1 JUMPDEST DUP2 SLOAD DUP2 MSTORE SWAP1
PUSH1 0x1 ADD SWAP1 PUSH1 0x20 ADD DUP1 DUP4 GT PUSH2 0x423 JUMPI DUP3 SWAP1
SUB PUSH1 0x1F AND DUP3 ADD SWAP2 JUMPDEST POP POP POP POP POP SWAP1 POP
SWAP1 JUMP JUMPDEST PUSH1 0x1 PUSH1 0x20 MSTORE DUP1 PUSH1 0x0 MSTORE PUSH1
0x40 PUSH1 0x0 KECCAK256 PUSH1 0x0 SWAP2 POP SWAP1 POP DUP1 PUSH1 0x0 ADD
SLOAD SWAP1 DUP1 PUSH1 0x1 ADD DUP1 SLOAD PUSH2 0x473 SWAP1 PUSH2 0x94B JUMP
JUMPDEST DUP1 PUSH1 0x1F ADD PUSH1 0x20 DUP1 SWAP2 DIV MUL PUSH1 0x20 ADD
PUSH1 0x40 MLOAD SWAP1 DUP2 ADD PUSH1 0x40 MSTORE DUP1 SWAP3 SWAP2 SWAP1 DUP2
DUP2 MSTORE PUSH1 0x20 ADD DUP3 DUP1 SLOAD PUSH2 0x49F SWAP1 PUSH2 0x94B JUMP
JUMPDEST DUP1 ISZERO PUSH2 0x4EC JUMPI DUP1 PUSH1 0x1F LT PUSH2 0x4C1 JUMPI
PUSH2 0x100 DUP1 DUP4 SLOAD DIV MUL DUP4 MSTORE SWAP2 PUSH1 0x20 ADD SWAP2
PUSH2 0x4EC JUMP JUMPDEST DUP3 ADD SWAP2 SWAP1 PUSH1 0x0 MSTORE PUSH1 0x20
PUSH1 0x0 KECCAK256 SWAP1 JUMPDEST DUP2 SLOAD DUP2 MSTORE SWAP1 PUSH1 0x1 ADD
SWAP1 PUSH1 0x20 ADD DUP1 DUP4 GT PUSH2 0x4CF JUMPI DUP3 SWAP1 SUB PUSH1 0x1F
AND DUP3 ADD SWAP2 JUMPDEST POP POP POP POP POP SWAP1 DUP1 PUSH1 0x2 ADD
SLOAD SWAP1 POP DUP4 JUMP JUMPDEST DUP3 DUP1 SLOAD PUSH2 0x508 SWAP1 PUSH2
0x94B JUMP JUMPDEST SWAP1 PUSH1 0x0 MSTORE PUSH1 0x20 PUSH1 0x0 KECCAK256
SWAP1 PUSH1 0x1F ADD PUSH1 0x20 SWAP1 DIV DUP2 ADD SWAP3 DUP3 PUSH2 0x52A
JUMPI PUSH1 0x0 DUP6 SSTORE PUSH2 0x571 JUMP JUMPDEST DUP3 PUSH1 0x1F LT
PUSH2 0x543 JUMPI DUP1 MLOAD PUSH1 0xFF NOT AND DUP4 DUP1 ADD OR DUP6 SSTORE
PUSH2 0x571 JUMP JUMPDEST DUP3 DUP1 ADD PUSH1 0x1 ADD DUP6 SSTORE DUP3 ISZERO
PUSH2 0x571 JUMPI SWAP2 DUP3 ADD JUMPDEST DUP3 DUP2 GT ISZERO PUSH2 0x570
JUMPI DUP3 MLOAD DUP3 SSTORE SWAP2 PUSH1 0x20 ADD SWAP2 SWAP1 PUSH1 0x1 ADD
SWAP1 PUSH2 0x555 JUMP JUMPDEST JUMPDEST POP SWAP1 POP PUSH2 0x57E SWAP2
SWAP1 PUSH2 0x582 JUMP JUMPDEST POP SWAP1 JUMP JUMPDEST JUMPDEST DUP1 DUP3 GT
ISZERO PUSH2 0x59B JUMPI PUSH1 0x0 DUP2 PUSH1 0x0 SWAP1 SSTORE POP PUSH1 0x1
ADD PUSH2 0x583 JUMP JUMPDEST POP SWAP1 JUMP JUMPDEST PUSH1 0x0 PUSH2 0x5B2
PUSH2 0x5AD DUP5 PUSH2 0x874 JUMP JUMPDEST PUSH2 0x84F JUMP JUMPDEST SWAP1
POP DUP3 DUP2 MSTORE PUSH1 0x20 DUP2 ADD DUP5 DUP5 DUP5 ADD GT ISZERO PUSH2
0x5CE JUMPI PUSH2 0x5CD PUSH2 0xA89 JUMP JUMPDEST JUMPDEST PUSH2 0x5D9 DUP5
DUP3 DUP6 PUSH2 0x909 JUMP JUMPDEST POP SWAP4 SWAP3 POP POP POP JUMP JUMPDEST
PUSH1 0x0 DUP2 CALLDATALOAD SWAP1 POP PUSH2 0x5F0 DUP2 PUSH2 0xAFB JUMP
JUMPDEST SWAP3 SWAP2 POP POP JUMP JUMPDEST PUSH1 0x0 DUP3 PUSH1 0x1F DUP4 ADD
SLT PUSH2 0x60B JUMPI PUSH2 0x60A PUSH2 0xA84 JUMP JUMPDEST JUMPDEST DUP2
CALLDATALOAD PUSH2 0x61B DUP5 DUP3 PUSH1 0x20 DUP7 ADD PUSH2 0x59F JUMP
JUMPDEST SWAP2 POP POP SWAP3 SWAP2 POP POP JUMP JUMPDEST PUSH1 0x0 DUP2
CALLDATALOAD SWAP1 POP PUSH2 0x633 DUP2 PUSH2 0xB12 JUMP JUMPDEST SWAP3 SWAP2
POP POP JUMP JUMPDEST PUSH1 0x0 PUSH1 0x20 DUP3 DUP5 SUB SLT ISZERO PUSH2
0x64F JUMPI PUSH2 0x64E PUSH2 0xA93 JUMP JUMPDEST JUMPDEST PUSH1 0x0 PUSH2
0x65D DUP5 DUP3 DUP6 ADD PUSH2 0x5E1 JUMP JUMPDEST SWAP2 POP POP SWAP3 SWAP2
POP POP JUMP JUMPDEST PUSH1 0x0 PUSH1 0x20 DUP3 DUP5 SUB SLT ISZERO PUSH2
0x67C JUMPI PUSH2 0x67B PUSH2 0xA93 JUMP JUMPDEST JUMPDEST PUSH1 0x0 DUP3 ADD
CALLDATALOAD PUSH8 0xFFFFFFFFFFFFFFFF DUP2 GT ISZERO PUSH2 0x69A JUMPI PUSH2
0x699 PUSH2 0xA8E JUMP JUMPDEST JUMPDEST PUSH2 0x6A6 DUP5 DUP3 DUP6 ADD PUSH2
0x5F6 JUMP JUMPDEST SWAP2 POP POP SWAP3 SWAP2 POP POP JUMP JUMPDEST PUSH1 0x0
PUSH1 0x20 DUP3 DUP5 SUB SLT ISZERO PUSH2 0x6C5 JUMPI PUSH2 0x6C4 PUSH2 0xA93
JUMP JUMPDEST JUMPDEST PUSH1 0x0 PUSH2 0x6D3 DUP5 DUP3 DUP6 ADD PUSH2 0x624
JUMP JUMPDEST SWAP2 POP POP SWAP3 SWAP2 POP POP JUMP JUMPDEST PUSH2 0x6E5
DUP2 PUSH2 0x8D3 JUMP JUMPDEST DUP3 MSTORE POP POP JUMP JUMPDEST PUSH1 0x0
PUSH2 0x6F6 DUP3 PUSH2 0x8A5 JUMP JUMPDEST PUSH2 0x700 DUP2 DUP6 PUSH2 0x8B0
JUMP JUMPDEST SWAP4 POP PUSH2 0x710 DUP2 DUP6 PUSH1 0x20 DUP7 ADD PUSH2 0x918
JUMP JUMPDEST PUSH2 0x719 DUP2 PUSH2 0xA98 JUMP JUMPDEST DUP5 ADD SWAP2 POP
POP SWAP3 SWAP2 POP POP JUMP JUMPDEST PUSH1 0x0 PUSH2 0x731 PUSH1 0x18 DUP4
PUSH2 0x8B0 JUMP JUMPDEST SWAP2 POP PUSH2 0x73C DUP3 PUSH2 0xAA9 JUMP
JUMPDEST PUSH1 0x20 DUP3 ADD SWAP1 POP SWAP2 SWAP1 POP JUMP JUMPDEST PUSH1
0x0 PUSH2 0x754 PUSH1 0x16 DUP4 PUSH2 0x8B0 JUMP JUMPDEST SWAP2 POP PUSH2
0x75F DUP3 PUSH2 0xAD2 JUMP JUMPDEST PUSH1 0x20 DUP3 ADD SWAP1 POP SWAP2
SWAP1 POP JUMP JUMPDEST PUSH2 0x773 DUP2 PUSH2 0x8FF JUMP JUMPDEST DUP3
MSTORE POP POP JUMP JUMPDEST PUSH1 0x0 PUSH1 0x20 DUP3 ADD SWAP1 POP PUSH2
0x78E PUSH1 0x0 DUP4 ADD DUP5 PUSH2 0x6DC JUMP JUMPDEST SWAP3 SWAP2 POP POP
JUMP JUMPDEST PUSH1 0x0 PUSH1 0x20 DUP3 ADD SWAP1 POP DUP2 DUP2 SUB PUSH1 0x0
DUP4 ADD MSTORE PUSH2 0x7AE DUP2 DUP5 PUSH2 0x6EB JUMP JUMPDEST SWAP1 POP
SWAP3 SWAP2 POP POP JUMP JUMPDEST PUSH1 0x0 PUSH1 0x20 DUP3 ADD SWAP1 POP
DUP2 DUP2 SUB PUSH1 0x0 DUP4 ADD MSTORE PUSH2 0x7CF DUP2 PUSH2 0x724 JUMP
JUMPDEST SWAP1 POP SWAP2 SWAP1 POP JUMP JUMPDEST PUSH1 0x0 PUSH1 0x20 DUP3
ADD SWAP1 POP DUP2 DUP2 SUB PUSH1 0x0 DUP4 ADD MSTORE PUSH2 0x7EF DUP2 PUSH2
0x747 JUMP JUMPDEST SWAP1 POP SWAP2 SWAP1 POP JUMP JUMPDEST PUSH1 0x0 PUSH1
0x20 DUP3 ADD SWAP1 POP PUSH2 0x80B PUSH1 0x0 DUP4 ADD DUP5 PUSH2 0x76A JUMP
JUMPDEST SWAP3 SWAP2 POP POP JUMP JUMPDEST PUSH1 0x0 PUSH1 0x60 DUP3 ADD
SWAP1 POP PUSH2 0x826 PUSH1 0x0 DUP4 ADD DUP7 PUSH2 0x76A JUMP JUMPDEST DUP2
DUP2 SUB PUSH1 0x20 DUP4 ADD MSTORE PUSH2 0x838 DUP2 DUP6 PUSH2 0x6EB JUMP
JUMPDEST SWAP1 POP PUSH2 0x847 PUSH1 0x40 DUP4 ADD DUP5 PUSH2 0x76A JUMP
JUMPDEST SWAP5 SWAP4 POP POP POP POP JUMP JUMPDEST PUSH1 0x0 PUSH2 0x859
PUSH2 0x86A JUMP JUMPDEST SWAP1 POP PUSH2 0x865 DUP3 DUP3 PUSH2 0x97D JUMP
JUMPDEST SWAP2 SWAP1 POP JUMP JUMPDEST PUSH1 0x0 PUSH1 0x40 MLOAD SWAP1 POP
SWAP1 JUMP JUMPDEST PUSH1 0x0 PUSH8 0xFFFFFFFFFFFFFFFF DUP3 GT ISZERO PUSH2
0x88F JUMPI PUSH2 0x88E PUSH2 0xA55 JUMP JUMPDEST JUMPDEST PUSH2 0x898 DUP3
PUSH2 0xA98 JUMP JUMPDEST SWAP1 POP PUSH1 0x20 DUP2 ADD SWAP1 POP SWAP2 SWAP1
POP JUMP JUMPDEST PUSH1 0x0 DUP2 MLOAD SWAP1 POP SWAP2 SWAP1 POP JUMP
JUMPDEST PUSH1 0x0 DUP3 DUP3 MSTORE PUSH1 0x20 DUP3 ADD SWAP1 POP SWAP3 SWAP2
POP POP JUMP JUMPDEST PUSH1 0x0 PUSH2 0x8CC DUP3 PUSH2 0x8DF JUMP JUMPDEST
SWAP1 POP SWAP2 SWAP1 POP JUMP JUMPDEST PUSH1 0x0 DUP2 ISZERO ISZERO SWAP1
POP SWAP2 SWAP1 POP JUMP JUMPDEST PUSH1 0x0 PUSH20
0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF DUP3 AND SWAP1 POP SWAP2 SWAP1 POP
JUMP JUMPDEST PUSH1 0x0 DUP2 SWAP1 POP SWAP2 SWAP1 POP JUMP JUMPDEST DUP3
DUP2 DUP4 CALLDATACOPY PUSH1 0x0 DUP4 DUP4 ADD MSTORE POP POP POP JUMP
JUMPDEST PUSH1 0x0 JUMPDEST DUP4 DUP2 LT ISZERO PUSH2 0x936 JUMPI DUP1 DUP3
ADD MLOAD DUP2 DUP5 ADD MSTORE PUSH1 0x20 DUP2 ADD SWAP1 POP PUSH2 0x91B JUMP
JUMPDEST DUP4 DUP2 GT ISZERO PUSH2 0x945 JUMPI PUSH1 0x0 DUP5 DUP5 ADD MSTORE
JUMPDEST POP POP POP POP JUMP JUMPDEST PUSH1 0x0 PUSH1 0x2 DUP3 DIV SWAP1 POP
PUSH1 0x1 DUP3 AND DUP1 PUSH2 0x963 JUMPI PUSH1 0x7F DUP3 AND SWAP2 POP
JUMPDEST PUSH1 0x20 DUP3 LT DUP2 EQ ISZERO PUSH2 0x977 JUMPI PUSH2 0x976
PUSH2 0xA26 JUMP JUMPDEST JUMPDEST POP SWAP2 SWAP1 POP JUMP JUMPDEST PUSH2
0x986 DUP3 PUSH2 0xA98 JUMP JUMPDEST DUP2 ADD DUP2 DUP2 LT PUSH8
0xFFFFFFFFFFFFFFFF DUP3 GT OR ISZERO PUSH2 0x9A5 JUMPI PUSH2 0x9A4 PUSH2
0xA55 JUMP JUMPDEST JUMPDEST DUP1 PUSH1 0x40 MSTORE POP POP POP JUMP JUMPDEST
PUSH1 0x0 PUSH2 0x9B9 DUP3 PUSH2 0x8FF JUMP JUMPDEST SWAP2 POP PUSH32
0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF DUP3 EQ
ISZERO PUSH2 0x9EC JUMPI PUSH2 0x9EB PUSH2 0x9F7 JUMP JUMPDEST JUMPDEST PUSH1
0x1 DUP3 ADD SWAP1 POP SWAP2 SWAP1 POP JUMP JUMPDEST PUSH32
0x4E487B7100000000000000000000000000000000000000000000000000000000 PUSH1 0x0
MSTORE PUSH1 0x11 PUSH1 0x4 MSTORE PUSH1 0x24 PUSH1 0x0 REVERT JUMPDEST
PUSH32 0x4E487B7100000000000000000000000000000000000000000000000000000000
PUSH1 0x0 MSTORE PUSH1 0x22 PUSH1 0x4 MSTORE PUSH1 0x24 PUSH1 0x0 REVERT
JUMPDEST PUSH32
0x4E487B7100000000000000000000000000000000000000000000000000000000 PUSH1 0x0
MSTORE PUSH1 0x41 PUSH1 0x4 MSTORE PUSH1 0x24 PUSH1 0x0 REVERT JUMPDEST PUSH1
0x0 DUP1 REVERT JUMPDEST PUSH1 0x0 DUP1 REVERT JUMPDEST PUSH1 0x0 DUP1 REVERT
JUMPDEST PUSH1 0x0 DUP1 REVERT JUMPDEST PUSH1 0x0 PUSH1 0x1F NOT PUSH1 0x1F
DUP4 ADD AND SWAP1 POP SWAP2 SWAP1 POP JUMP JUMPDEST PUSH32
0x73656E6465722068617320616C726561647920766F7465640000000000000000 PUSH1 0x0
DUP3 ADD MSTORE POP JUMP JUMPDEST PUSH32
0x696E76616C696420766F74652073656C656374696F6E00000000000000000000 PUSH1 0x0
DUP3 ADD MSTORE POP JUMP JUMPDEST PUSH2 0xB04 DUP2 PUSH2 0x8C1 JUMP JUMPDEST
DUP2 EQ PUSH2 0xB0F JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP JUMP JUMPDEST
PUSH2 0xB1B DUP2 PUSH2 0x8FF JUMP JUMPDEST DUP2 EQ PUSH2 0xB26 JUMPI PUSH1
0x0 DUP1 REVERT JUMPDEST POP JUMP INVALID LOG2 PUSH5 0x6970667358 0x22 SLT
KECCAK256 0xA5 0xD DUP10 ADDMOD 0xE8 0xF SSTORE PUSH31
0xC91730863500E2C51DAAA1A7B297ADC495DCB50976B5061A64736F6C634300 ADDMOD SMOD
STOP CALLER
</code></pre>



## Security holes
- Did you notice the (intentional) security holes in the Choices contract?
  - There were at least two, one inherent to Solidity and one I put in there
</textarea></section>

  </section>

<!-- ============================================================ -->
  
  <section>

    <section id="debtor" data-markdown class="center"><textarea>
# Debtor's Example
    </textarea></section>

    <section data-markdown data-separator="^\n\n\n"><textarea>
## A Circle of Debt
- A group of friends always cover each other for expenses
- They want a way to resolve these debts
- Example:
  - Alice pays `$`5 to cover Bob
  - Bob pays `$`5 to cover Charlie
  - Charlie pays `$`10 to cover Alice
  - The net result is that Alice owes `$`5 to Charlie; all other debts cancel out
- We'll implement this as a smart contract in Solidity on Ethereum



## Design considerations
- The blockchain will hold the history of who owes who
- Nobody wants to remember people by their Ethereum address
  - So we will use an *alias*, which is a string ("alice", "bob", etc.) that corresponds to an address
  - It has an optional *name* field as well
- The group of friends all trust each other, so either side can enter a debt
  - But Alice cannot enter a debt between Bob and Charlie



## Insight
- The key insight is that if Alice pays Bob $x$, then Alice's balance goes *up* by $x$, and Bob's goes *down* by $x$
  - A negative balance means you owe money
  - A positive balance means you are owed money
- The system will keep track of how much one owes or is owed, but not necessarily who to



## Development
- Let's jointly live develop it on [remix.ethereum.org](https://remix.ethereum.org/)



## Deployment
- A request: please do not go ahead of me in the following deployment steps
- This has already been deployed on our private Ethereum blockchain
  - But if we wanted to deploy it ourselves, you could do so from Remix by following the same steps as in the [dApp Introduction](../hws/dappintro/index.html) assignment
- I've added an alias for me, but not for any of you
- On the Collab landing page is the relevant contract address (and other information)
- Look at the Blockchain Explorer
  - The smart contract was deployed in a specific block
  - The adding of some aliases was in a specific block



## Interacting via geth
- You should all start up your geth node via:
  ```
geth --datadir /path/to/ethprivate \
     --networkid 12345678 --maxpeers 1
```
  - Change `/path/to/ethprivate` and the numerical network ID, of course
- Once done, you should start a geth terminal in a *new* window/tab:
```
geth attach /path/to/ethprivate/geth.ipc
```



## Relevant information
- On the Collab landing page, at the bottom, are a few pieces of information we will need:
  - The smart contract address
  - The ABI for this smart contract -- you will need to copy that shortly
  - A link to this part of the slide set so you can copy-and-paste some of the code



## Transactions from geth
- We are going to call the smart contract directly from geth
- First, save the smart contract address in a variable:
  ```
var addr = "0xffffffffffffffffffffffffffffffffffffffff";
```
  - But use the actual address, not that address!
- Next we have to save the ABI:
  ```
var abi = [...];
```
  - Copy-and-paste the ABI from the Collab landing page into that command
  - Notice no quotes around the variable's value!
  - It should present that same ABI back to you, but nicely formatted



## Transactions from geth
- Next we have to have geth create a contract object for us:
  ```
var interface = eth.contract(abi);
```
- Lastly, we need to link that to the specific contract address that we are going to be using:
  ```
var contract = interface.at(addr);
```



## Geth read transactions
- We can call read-only transactions (views) via the `.call()` method
- To read a variable:
  ```
contract.num_entries.call()
```
- To read a mapping:
  ```
contract.entries.call(0)
```
- To get a name from a mapping:
  ```
contract.entries.call(0)[2]
```
- To call a method:
  ```
contract.thisMethodDoesNotExist.call()
```



## Geth write transactions
- First, unlock your account:
  ```
personal.unlockAccount(eth.coinbase,"password",0)
```
- You do not have to start and stop the miner, as I will do that for you
- And the blockchain explorer is now updating every 1 minute



## Adding an alias
- You have to add yourself as an alias
- Request: please use your UVA userid as the alias itself
  - If you don't want to use your own, make up a believable fake one
- Remember: please don't start the miner!  I'm doing that for you.



## Adding an alias
- Transactions that write to the blockchain use the `.sendTransaction()` method
  ```
contract.addAlias.sendTransaction("mst3k", 
         "Your Name", {from:eth.coinbase, gas:1000000})
```
- Don't use mst3k!  Use your userid and name
  - Possibly fake, but make it realistic
- Notice, in the value printed after that call, the transaction hash
  - Search for the address in the Blockchain Explorer
  - It may take a minute or two for that to refresh...



## View the list of debts
- We have a web page that allows you to view all the entered aliases and who owes what
- The URL is...



## Pay off some debts!
- You can now enter some debts:
  ```
contract.payToAlias.sendTransaction("mst3k",17,
               {from:eth.coinbase, gas:1000000});
```
- Don't use mst3k!  Use the userid of the *other* person
- Note that this is entering that the other person owes *you* money
  - If you owe them money, you would enter a negative value
- The amount must be between -100 and 100, inclusive
- And, again, view the web page for this exercise that lists the current balances
- You can also see those transactions in the blockchain explorer
  - Note the transaction hash when you enter that command



## The result...
... how much do I owe???

Also, we have the source code available

The code is in [slides/code/Debt.sol](code/Debts.sol.html) ([src](code/Debts.sol))

</textarea></section>

  </section>

<!-- ============================================================ -->
  
  <section>

    <section id="debugging" data-markdown class="center"><textarea>
# Testing & Debugging
    </textarea></section>

    <section data-markdown data-separator="^\n\n\n" id='require'><textarea>
## Use `require()` with 2 parameters

- Consider:
  ```
require (value > 0);
```
- If this reverts, all Remix will state is that the contract reverted, but not where or why
- Instead, use:
  ```
require (value > 0, "value must be > 0 in foo()");
```
- Now Remix will report that specific string if/when it reverts
    </textarea></section>

    <section data-markdown data-separator="^\n\n\n"><textarea>
## Use `require()` to assure the correct state
- Using `require()` a lot to make sure that the variables are in the state you expect them to be
```
require (msg.value > 0,
           "must transfer ether with this transaction");
require (from_address != address(0), 
           "must specify a non-null from address");
require (to_address != address(0), 
           "must specify a non-null to address");
// and so on...
```



## Capturing intermediate state
- We don't have print statements to ensure that our intermediate values are correct
- So instead we save those values in state variables
- Make sure those variables are `public`!!!
- Once the function is run, you can view those variables in Remix



## Capturing intermediate state
```
contract Test {
  uint public debug1;
  uint public debug2;

  function whyDontYouWork(uint a, uint b, uint c) 
                          public returns (uint) {
    uint x = 10**a;
    debug1 = x;
    x = x / b + c;
    debug2 = x;
    return x*123;
  }
}



## Managing setup
- Some projects will require multiple contracts working together
- We can create a third contract to manage all this setup



## Managing setup
```
contract Test {
  address erc20 = 0x123456...;
  address tokenUser = 0x123456...;
  function setup() {
    IERC20(erc20).callFunction(param1,2,3);
    tokenUser.setERC20(erc20);
    // ... and so on
  }
}
```



## Still stuck?
- Try adding in more `require()` statements
- Note that a subtraction on a uint that causes a negative number will revert the call

</textarea></section>

  </section>

<!-- ============================================================ -->
	
      </div>

    </div>

    <script src='../slides/reveal.js/dist/reveal.js'></script><script src='../slides/reveal.js/plugin/zoom/zoom.js'></script><script src='../slides/reveal.js/plugin/notes/notes.js'></script><script src='../slides/reveal.js/plugin/search/search.js'></script><script src='../slides/reveal.js/plugin/markdown/markdown.js'></script><script src='../slides/reveal.js/plugin/highlight/highlight.js'></script><script src='../slides/reveal.js/plugin/math/math.js'></script>
    <script src="../slides/settings.js"></script>

    <script>
      var vals = new Array();
      
      // often changed variables
      vals['btc_price'] = 65000;

      // rarely changed variables
      vals['btc_reward_btc'] = 6.25;

      // computations; not changed
      vals['btc_reward_usd'] = vals['btc_price'] * vals['btc_reward_btc'];

      Reveal.addEventListener( 'update', function() { myupdate(); } );

      function myupdate() {
	  for (var k in vals) {
	      if ( document.getElementById(k) ) {
		  document.getElementById(k).innerHTML = vals[k].toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	      }
	  }
      }
      
    </script>


    
  </body>
</html>
